!function(root,factory){"function"==typeof define&&define.amd?define("simditor",["jquery","simple-module","simple-uploader"],function($,SimpleModule,simpleUploader){return root.returnExportsGlobal=factory($,SimpleModule,simpleUploader)}):"object"==typeof exports?module.exports=factory(require("jquery"),require("simple-module"),require("simple-uploader")):root.Simditor=factory(jQuery,SimpleModule,simple.uploader)}(this,function($,SimpleModule,simpleUploader){var Selection,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};Selection=function(_super){function Selection(){return Selection.__super__.constructor.apply(this,arguments)}return __extends(Selection,_super),Selection.className="Selection",Selection.prototype._init=function(){return this.editor=this._module,this.sel=document.getSelection()},Selection.prototype.clear=function(){var e;try{return this.sel.removeAllRanges()}catch(_error){e=_error}},Selection.prototype.getRange=function(){return this.editor.inputManager.focused&&this.sel.rangeCount?this.sel.getRangeAt(0):null},Selection.prototype.selectRange=function(range){return this.clear(),this.sel.addRange(range),this.editor.inputManager.focused||!this.editor.util.browser.firefox&&!this.editor.util.browser.msie?void 0:this.editor.body.focus()},Selection.prototype.rangeAtEndOf=function(node,range){var endNode,endNodeLength,result;return null==range&&(range=this.getRange()),null!=range&&range.collapsed?(node=$(node)[0],endNode=range.endContainer,endNodeLength=this.editor.util.getNodeLength(endNode),range.endOffset===endNodeLength-1&&$(endNode).contents().last().is("br")||range.endOffset===endNodeLength?node===endNode?!0:$.contains(node,endNode)?(result=!0,$(endNode).parentsUntil(node).addBack().each(function(){return function(i,n){var $lastChild,nodes;return nodes=$(n).parent().contents().filter(function(){return!(this!==n&&3===this.nodeType&&!this.nodeValue)}),$lastChild=nodes.last(),$lastChild.get(0)===n||$lastChild.is("br")&&$lastChild.prev().get(0)===n?void 0:(result=!1,!1)}}(this)),result):!1:!1):void 0},Selection.prototype.rangeAtStartOf=function(node,range){var result,startNode;return null==range&&(range=this.getRange()),null!=range&&range.collapsed?(node=$(node)[0],startNode=range.startContainer,0!==range.startOffset?!1:node===startNode?!0:$.contains(node,startNode)?(result=!0,$(startNode).parentsUntil(node).addBack().each(function(){return function(i,n){var nodes;return nodes=$(n).parent().contents().filter(function(){return!(this!==n&&3===this.nodeType&&!this.nodeValue)}),nodes.first().get(0)!==n?result=!1:void 0}}(this)),result):!1):void 0},Selection.prototype.insertNode=function(node,range){return null==range&&(range=this.getRange()),null!=range?(node=$(node)[0],range.insertNode(node),this.setRangeAfter(node,range)):void 0},Selection.prototype.setRangeAfter=function(node,range){return null==range&&(range=this.getRange()),null!=range?(node=$(node)[0],range.setEndAfter(node),range.collapse(!1),this.selectRange(range)):void 0},Selection.prototype.setRangeBefore=function(node,range){return null==range&&(range=this.getRange()),null!=range?(node=$(node)[0],range.setEndBefore(node),range.collapse(!1),this.selectRange(range)):void 0},Selection.prototype.setRangeAtStartOf=function(node,range){return null==range&&(range=this.getRange()),node=$(node).get(0),range.setEnd(node,0),range.collapse(!1),this.selectRange(range)},Selection.prototype.setRangeAtEndOf=function(node,range){var $lastNode,$node,contents,lastChild,lastText,nodeLength;return null==range&&(range=this.getRange()),$node=$(node),node=$node.get(0),$node.is("pre")?(contents=$node.contents(),contents.length>0?(lastChild=contents.last(),lastText=lastChild.text(),"\n"===lastText.charAt(lastText.length-1)?range.setEnd(lastChild[0],this.editor.util.getNodeLength(lastChild[0])-1):range.setEnd(lastChild[0],this.editor.util.getNodeLength(lastChild[0]))):range.setEnd(node,0)):(nodeLength=this.editor.util.getNodeLength(node),3!==node.nodeType&&nodeLength>0&&($lastNode=$(node).contents().last(),$lastNode.is("br")?nodeLength-=1:3!==$lastNode[0].nodeType&&this.editor.util.isEmptyNode($lastNode)&&($lastNode.append(this.editor.util.phBr),node=$lastNode[0],nodeLength=0)),range.setEnd(node,nodeLength)),range.collapse(!1),this.selectRange(range)},Selection.prototype.deleteRangeContents=function(range){var endRange,startRange;return null==range&&(range=this.getRange()),startRange=range.cloneRange(),endRange=range.cloneRange(),startRange.collapse(!0),endRange.collapse(!1),!range.collapsed&&this.rangeAtStartOf(this.editor.body,startRange)&&this.rangeAtEndOf(this.editor.body,endRange)?(this.editor.body.empty(),range.setStart(this.editor.body[0],0),range.collapse(!0),this.selectRange(range)):range.deleteContents(),range},Selection.prototype.breakBlockEl=function(el,range){var $el;return null==range&&(range=this.getRange()),$el=$(el),range.collapsed?(range.setStartBefore($el.get(0)),range.collapsed?$el:$el.before(range.extractContents())):$el},Selection.prototype.save=function(range){var endCaret,endRange,startCaret;return null==range&&(range=this.getRange()),this._selectionSaved?void 0:(endRange=range.cloneRange(),endRange.collapse(!1),startCaret=$("<span/>").addClass("simditor-caret-start"),endCaret=$("<span/>").addClass("simditor-caret-end"),endRange.insertNode(endCaret[0]),range.insertNode(startCaret[0]),this.clear(),this._selectionSaved=!0)},Selection.prototype.restore=function(){var endCaret,endContainer,endOffset,range,startCaret,startContainer,startOffset;return this._selectionSaved?(startCaret=this.editor.body.find(".simditor-caret-start"),endCaret=this.editor.body.find(".simditor-caret-end"),startCaret.length&&endCaret.length?(startContainer=startCaret.parent(),startOffset=startContainer.contents().index(startCaret),endContainer=endCaret.parent(),endOffset=endContainer.contents().index(endCaret),startContainer[0]===endContainer[0]&&(endOffset-=1),range=document.createRange(),range.setStart(startContainer.get(0),startOffset),range.setEnd(endContainer.get(0),endOffset),startCaret.remove(),endCaret.remove(),this.selectRange(range)):(startCaret.remove(),endCaret.remove()),this._selectionSaved=!1,range):!1},Selection}(SimpleModule);var Formatter,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};Formatter=function(_super){function Formatter(){return Formatter.__super__.constructor.apply(this,arguments)}return __extends(Formatter,_super),Formatter.prototype._init=function(){return this.editor=this._module,this._allowedTags=["br","a","img","b","strong","i","u","font","p","ul","ol","li","blockquote","pre","h1","h2","h3","h4","hr"],this._allowedAttributes={img:["src","alt","width","height","data-image-src","data-image-size","data-image-name","data-non-image"],a:["href","target"],font:["color"],pre:["data-lang","class"],p:["data-indent"],h1:["data-indent"],h2:["data-indent"],h3:["data-indent"],h4:["data-indent"]},this.editor.body.on("click","a",function(){return function(){return!1}}(this))},Formatter.prototype.decorate=function($el){return null==$el&&($el=this.editor.body),this.editor.trigger("decorate",[$el])},Formatter.prototype.undecorate=function($el){return null==$el&&($el=this.editor.body.clone()),this.editor.trigger("undecorate",[$el]),$.trim($el.html())},Formatter.prototype.autolink=function($el){var $node,findLinkNode,lastIndex,linkNodes,match,re,replaceEls,text,uri,_i,_len;for(null==$el&&($el=this.editor.body),linkNodes=[],findLinkNode=function($parentNode){return $parentNode.contents().each(function(i,node){var $node,text;return $node=$(node),$node.is("a")||$node.closest("a, pre",$el).length?void 0:$node.contents().length?findLinkNode($node):(text=$node.text())&&/https?:\/\/|www\./gi.test(text)?linkNodes.push($node):void 0})},findLinkNode($el),re=/(https?:\/\/|www\.)[\w\-\.\?&=\/#%:,@\!\+]+/gi,_i=0,_len=linkNodes.length;_len>_i;_i++){for($node=linkNodes[_i],text=$node.text(),replaceEls=[],match=null,lastIndex=0;null!==(match=re.exec(text));)replaceEls.push(document.createTextNode(text.substring(lastIndex,match.index))),lastIndex=re.lastIndex,uri=/^(http(s)?:\/\/|\/)/.test(match[0])?match[0]:"http://"+match[0],replaceEls.push($('<a href="'+uri+'" rel="nofollow"></a>').text(match[0])[0]);replaceEls.push(document.createTextNode(text.substring(lastIndex))),$node.replaceWith($(replaceEls))}return $el},Formatter.prototype.format=function($el){var $node,blockNode,n,node,_i,_j,_len,_len1,_ref,_ref1;if(null==$el&&($el=this.editor.body),$el.is(":empty"))return $el.append("<p>"+this.editor.util.phBr+"</p>"),$el;for(_ref=$el.contents(),_i=0,_len=_ref.length;_len>_i;_i++)n=_ref[_i],this.cleanNode(n,!0);for(_ref1=$el.contents(),_j=0,_len1=_ref1.length;_len1>_j;_j++)node=_ref1[_j],$node=$(node),$node.is("br")?("undefined"!=typeof blockNode&&null!==blockNode&&(blockNode=null),$node.remove()):this.editor.util.isBlockNode(node)?$node.is("li")?blockNode&&blockNode.is("ul, ol")?blockNode.append(node):(blockNode=$("<ul/>").insertBefore(node),blockNode.append(node)):blockNode=null:((!blockNode||blockNode.is("ul, ol"))&&(blockNode=$("<p/>").insertBefore(node)),blockNode.append(node));return $el},Formatter.prototype.cleanNode=function(node,recursive){var $childImg,$node,$p,$td,allowedAttributes,attr,contents,isDecoration,n,text,textNode,_i,_j,_len,_len1,_ref,_ref1;if($node=$(node),$node.length>0){if(3===$node[0].nodeType)return text=$node.text().replace(/(\r\n|\n|\r)/gm,""),void(text?(textNode=document.createTextNode(text),$node.replaceWith(textNode)):$node.remove());if(contents=$node.contents(),isDecoration=$node.is('[class^="simditor-"]'),$node.is(this._allowedTags.join(","))||isDecoration){if($node.is("a")&&($childImg=$node.find("img")).length>0&&($node.replaceWith($childImg),$node=$childImg,contents=null),$node.is("img")&&$node.hasClass("uploading")&&$node.remove(),!isDecoration)for(allowedAttributes=this._allowedAttributes[$node[0].tagName.toLowerCase()],_ref=$.makeArray($node[0].attributes),_i=0,_len=_ref.length;_len>_i;_i++)attr=_ref[_i],null!=allowedAttributes&&(_ref1=attr.name,__indexOf.call(allowedAttributes,_ref1)>=0)||$node.removeAttr(attr.name)}else 1!==$node[0].nodeType||$node.is(":empty")?($node.remove(),contents=null):$node.is("div, article, dl, header, footer, tr")?($node.append("<br/>"),contents.first().unwrap()):$node.is("table")?($p=$("<p/>"),$node.find("tr").each(function(){return function(i,tr){return $p.append($(tr).text()+"<br/>")}}(this)),$node.replaceWith($p),contents=null):$node.is("thead, tfoot")?($node.remove(),contents=null):$node.is("th")?($td=$("<td/>").append($node.contents()),$node.replaceWith($td)):contents.first().unwrap();if(recursive&&null!=contents&&!$node.is("pre"))for(_j=0,_len1=contents.length;_len1>_j;_j++)n=contents[_j],this.cleanNode(n,!0);return null}},Formatter.prototype.clearHtml=function(html,lineBreak){var container,contents,result;return null==lineBreak&&(lineBreak=!0),container=$("<div/>").append(html),contents=container.contents(),result="",contents.each(function(_this){return function(i,node){var $node,children;return 3===node.nodeType?result+=node.nodeValue:1===node.nodeType&&($node=$(node),children=$node.contents(),children.length>0&&(result+=_this.clearHtml(children)),lineBreak&&i<contents.length-1&&$node.is("br, p, div, li, tr, pre, address, artticle, aside, dl, figcaption, footer, h1, h2, h3, h4, header"))?result+="\n":void 0}}(this)),result},Formatter.prototype.beautify=function($contents){var uselessP;return uselessP=function($el){return!!($el.is("p")&&!$el.text()&&$el.children(":not(br)").length<1)},$contents.each(function(){return function(i,el){var $el;return $el=$(el),$el.is(':not(img, br, col, td, hr, [class^="simditor-"]):empty')&&$el.remove(),uselessP($el)&&$el.remove(),$el.find(':not(img, br, col, td, hr, [class^="simditor-"]):empty').remove()}}(this))},Formatter}(SimpleModule);var InputManager,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};InputManager=function(_super){function InputManager(){return InputManager.__super__.constructor.apply(this,arguments)}return __extends(InputManager,_super),InputManager.prototype.opts={pasteImage:!1},InputManager.prototype._modifierKeys=[16,17,18,91,93,224],InputManager.prototype._arrowKeys=[37,38,39,40],InputManager.prototype._init=function(){var submitKey;return this.editor=this._module,this.opts.pasteImage&&"string"!=typeof this.opts.pasteImage&&(this.opts.pasteImage="inline"),this._keystrokeHandlers={},this._shortcuts={},this._pasteArea=$("<div/>").css({width:"1px",height:"1px",overflow:"hidden",position:"fixed",right:"0",bottom:"100px"}).attr({tabIndex:"-1",contentEditable:!0}).addClass("simditor-paste-area").appendTo(this.editor.el),this._cleanPasteArea=$("<textarea/>").css({width:"1px",height:"1px",overflow:"hidden",position:"fixed",right:"0",bottom:"101px"}).attr({tabIndex:"-1"}).addClass("simditor-clean-paste-area").appendTo(this.editor.el),$(document).on("selectionchange.simditor"+this.editor.id,function(_this){return function(){return _this.focused?(_this._selectionTimer&&(clearTimeout(_this._selectionTimer),_this._selectionTimer=null),_this._selectionTimer=setTimeout(function(){return _this.editor.trigger("selectionchanged")},50)):void 0}}(this)),this.editor.on("valuechanged",function(_this){return function(){if(!_this.editor.util.closestBlockEl()){if(!_this.focused)return;_this.editor.selection.save(),_this.editor.formatter.format(),_this.editor.selection.restore()}return _this.editor.body.find("hr, pre, .simditor-table").each(function(i,el){var $el,formatted;return $el=$(el),($el.parent().is("blockquote")||$el.parent()[0]===_this.editor.body[0])&&(formatted=!1,0===$el.next().length&&($("<p/>").append(_this.editor.util.phBr).insertAfter($el),formatted=!0),0===$el.prev().length&&($("<p/>").append(_this.editor.util.phBr).insertBefore($el),formatted=!0),formatted)?setTimeout(function(){return _this.editor.trigger("valuechanged")},10):void 0}),_this.editor.body.find("pre:empty").append(_this.editor.util.phBr),!_this.editor.util.supportSelectionChange&&_this.focused?_this.editor.trigger("selectionchanged"):void 0}}(this)),this.editor.on("selectionchanged",function(_this){return function(){return _this.editor.undoManager.update()}}(this)),this.editor.body.on("keydown",$.proxy(this._onKeyDown,this)).on("keypress",$.proxy(this._onKeyPress,this)).on("keyup",$.proxy(this._onKeyUp,this)).on("mouseup",$.proxy(this._onMouseUp,this)).on("focus",$.proxy(this._onFocus,this)).on("blur",$.proxy(this._onBlur,this)).on("paste",$.proxy(this._onPaste,this)).on("drop",$.proxy(this._onDrop,this)),this.editor.util.browser.firefox&&(this.addShortcut("cmd+37",function(_this){return function(e){return e.preventDefault(),_this.editor.selection.sel.modify("move","backward","lineboundary"),!1}}(this)),this.addShortcut("cmd+39",function(_this){return function(e){return e.preventDefault(),_this.editor.selection.sel.modify("move","forward","lineboundary"),!1}}(this))),submitKey=this.editor.util.os.mac?"cmd+13":"ctrl+13",this.addShortcut(submitKey,function(_this){return function(){return _this.editor.el.closest("form").find("button:submit").click(),!1}}(this)),this.editor.textarea.attr("autofocus")?setTimeout(function(_this){return function(){return _this.editor.focus()}}(this),0):void 0},InputManager.prototype._onFocus=function(){return this.editor.el.addClass("focus").removeClass("error"),this.focused=!0,this.lastCaretPosition=null,setTimeout(function(_this){return function(){return _this.editor.triggerHandler("focus"),_this.editor.trigger("selectionchanged")}}(this),0)},InputManager.prototype._onBlur=function(){var _ref;return this.editor.el.removeClass("focus"),this.editor.sync(),this.focused=!1,this.lastCaretPosition=null!=(_ref=this.editor.undoManager.currentState())?_ref.caret:void 0,this.editor.triggerHandler("blur")},InputManager.prototype._onMouseUp=function(){return this.editor.util.supportSelectionChange?void 0:setTimeout(function(_this){return function(){return _this.editor.trigger("selectionchanged")}}(this),0)},InputManager.prototype._onKeyDown=function(e){var $blockEl,metaKey,result,shortcutKey,_base,_ref,_ref1;if(this.editor.triggerHandler(e)===!1)return!1;if(shortcutKey=this.editor.util.getShortcutKey(e),this._shortcuts[shortcutKey])return this._shortcuts[shortcutKey].call(this,e);if(e.which in this._keystrokeHandlers){if(result="function"==typeof(_base=this._keystrokeHandlers[e.which])["*"]?_base["*"](e):void 0)return this.editor.trigger("valuechanged"),!1;if(this.editor.util.traverseUp(function(_this){return function(node){var handler,_ref;if(1===node.nodeType)return handler=null!=(_ref=_this._keystrokeHandlers[e.which])?_ref[node.tagName.toLowerCase()]:void 0,result="function"==typeof handler?handler(e,$(node)):void 0,result===!0||result===!1?!1:void 0}}(this)),result)return this.editor.trigger("valuechanged"),!1}return _ref=e.which,__indexOf.call(this._modifierKeys,_ref)>=0||(_ref1=e.which,__indexOf.call(this._arrowKeys,_ref1)>=0)||(metaKey=this.editor.util.metaKey(e),$blockEl=this.editor.util.closestBlockEl(),metaKey&&86===e.which)?void 0:(this.editor.util.browser.webkit&&8===e.which&&this.editor.selection.rangeAtStartOf($blockEl)?(setTimeout(function(_this){return function(){var $newBlockEl;return $newBlockEl=_this.editor.util.closestBlockEl(),_this.editor.selection.save(),_this.editor.formatter.cleanNode($newBlockEl,!0),_this.editor.selection.restore(),_this.editor.trigger("valuechanged")}}(this),10),this.typing=!0):this._typing?(this._typing!==!0&&clearTimeout(this._typing),this._typing=setTimeout(function(_this){return function(){return _this.editor.trigger("valuechanged"),_this._typing=!1}}(this),200)):(setTimeout(function(_this){return function(){return _this.editor.trigger("valuechanged")}}(this),10),this._typing=!0),null)},InputManager.prototype._onKeyPress=function(e){return this.editor.triggerHandler(e)===!1?!1:void 0},InputManager.prototype._onKeyUp=function(e){var p,_ref;return this.editor.triggerHandler(e)===!1?!1:!this.editor.util.supportSelectionChange&&(_ref=e.which,__indexOf.call(this._arrowKeys,_ref)>=0)?(this.editor.trigger("selectionchanged"),void this.editor.undoManager.update()):void(8!==e.which&&46!==e.which||!this.editor.util.isEmptyNode(this.editor.body)||(this.editor.body.empty(),p=$("<p/>").append(this.editor.util.phBr).appendTo(this.editor.body),this.editor.selection.setRangeAtStartOf(p)))},InputManager.prototype._onPaste=function(e){var $blockEl,cleanPaste,imageFile,pasteItem,range,uploadOpt,_ref;if(this.editor.triggerHandler(e)===!1)return!1;if(range=this.editor.selection.deleteRangeContents(),range.collapsed||range.collapse(!0),$blockEl=this.editor.util.closestBlockEl(),cleanPaste=$blockEl.is("pre, table"),e.originalEvent.clipboardData&&e.originalEvent.clipboardData.items&&e.originalEvent.clipboardData.items.length>0&&(pasteItem=e.originalEvent.clipboardData.items[0],/^image\//.test(pasteItem.type)&&!cleanPaste)){if(imageFile=pasteItem.getAsFile(),null==imageFile||!this.opts.pasteImage)return;return imageFile.name||(imageFile.name="Clipboard Image.png"),uploadOpt={},uploadOpt[this.opts.pasteImage]=!0,null!=(_ref=this.editor.uploader)&&_ref.upload(imageFile,uploadOpt),!1}return this.editor.selection.save(range),cleanPaste?(this._cleanPasteArea.focus(),this.editor.util.browser.firefox?(e.preventDefault(),this._cleanPasteArea.val(e.originalEvent.clipboardData.getData("text/plain"))):this.editor.util.browser.msie&&10===this.editor.util.browser.version&&(e.preventDefault(),this._cleanPasteArea.val(window.clipboardData.getData("Text")))):(this._pasteArea.focus(),this.editor.util.browser.msie&&10===this.editor.util.browser.version&&(e.preventDefault(),this._pasteArea.html(window.clipboardData.getData("Text")))),setTimeout(function(_this){return function(){var $img,blob,children,insertPosition,lastLine,line,lines,node,pasteContent,_i,_j,_k,_l,_len,_len1,_len2,_len3,_len4,_m,_ref1,_ref2,_ref3;if(_this._pasteArea.is(":empty")&&!_this._cleanPasteArea.val()?pasteContent=null:cleanPaste?pasteContent=_this._cleanPasteArea.val():(pasteContent=$("<div/>").append(_this._pasteArea.contents()),_this.editor.formatter.format(pasteContent),_this.editor.formatter.decorate(pasteContent),_this.editor.formatter.beautify(pasteContent.children()),pasteContent=pasteContent.contents()),_this._pasteArea.empty(),_this._cleanPasteArea.val(""),range=_this.editor.selection.restore(),_this.editor.triggerHandler("pasting",[pasteContent])!==!1&&pasteContent){if(cleanPaste)if($blockEl.is("table")){for(lines=pasteContent.split("\n"),lastLine=lines.pop(),_i=0,_len=lines.length;_len>_i;_i++)line=lines[_i],_this.editor.selection.insertNode(document.createTextNode(line)),_this.editor.selection.insertNode($("<br/>"));_this.editor.selection.insertNode(document.createTextNode(lastLine))}else for(pasteContent=$("<div/>").text(pasteContent),_ref1=pasteContent.contents(),_j=0,_len1=_ref1.length;_len1>_j;_j++)node=_ref1[_j],_this.editor.selection.insertNode($(node)[0],range);else if($blockEl.is(_this.editor.body))for(_k=0,_len2=pasteContent.length;_len2>_k;_k++)node=pasteContent[_k],_this.editor.selection.insertNode(node,range);else{if(pasteContent.length<1)return;if(1===pasteContent.length)if(pasteContent.is("p"))if(children=pasteContent.contents(),1===children.length&&children.is("img")){if($img=children,/^data:image/.test($img.attr("src"))){if(!_this.opts.pasteImage)return;return blob=_this.editor.util.dataURLtoBlob($img.attr("src")),blob.name="Clipboard Image.png",uploadOpt={},uploadOpt[_this.opts.pasteImage]=!0,void(null!=(_ref2=_this.editor.uploader)&&_ref2.upload(blob,uploadOpt))}if($img.is('img[src^="webkit-fake-url://"]'))return}else for(_l=0,_len3=children.length;_len3>_l;_l++)node=children[_l],_this.editor.selection.insertNode(node,range);else if($blockEl.is("p")&&_this.editor.util.isEmptyNode($blockEl))$blockEl.replaceWith(pasteContent),_this.editor.selection.setRangeAtEndOf(pasteContent,range);else if(pasteContent.is("ul, ol"))if(1===pasteContent.find("li").length)for(pasteContent=$("<div/>").text(pasteContent.text()),_ref3=pasteContent.contents(),_m=0,_len4=_ref3.length;_len4>_m;_m++)node=_ref3[_m],_this.editor.selection.insertNode($(node)[0],range);else $blockEl.is("li")?($blockEl.parent().after(pasteContent),_this.editor.selection.setRangeAtEndOf(pasteContent,range)):($blockEl.after(pasteContent),_this.editor.selection.setRangeAtEndOf(pasteContent,range));else $blockEl.after(pasteContent),_this.editor.selection.setRangeAtEndOf(pasteContent,range);else $blockEl.is("li")&&($blockEl=$blockEl.parent()),_this.editor.selection.rangeAtStartOf($blockEl,range)?insertPosition="before":_this.editor.selection.rangeAtEndOf($blockEl,range)?insertPosition="after":(_this.editor.selection.breakBlockEl($blockEl,range),insertPosition="before"),$blockEl[insertPosition](pasteContent),_this.editor.selection.setRangeAtEndOf(pasteContent.last(),range)}return _this.editor.trigger("valuechanged")}}}(this),10)},InputManager.prototype._onDrop=function(e){return this.editor.triggerHandler(e)===!1?!1:setTimeout(function(_this){return function(){return _this.editor.trigger("valuechanged")}}(this),0)},InputManager.prototype.addKeystrokeHandler=function(key,node,handler){return this._keystrokeHandlers[key]||(this._keystrokeHandlers[key]={}),this._keystrokeHandlers[key][node]=handler},InputManager.prototype.addShortcut=function(keys,handler){return this._shortcuts[keys]=$.proxy(handler,this)},InputManager}(SimpleModule);var Keystroke,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};Keystroke=function(_super){function Keystroke(){return Keystroke.__super__.constructor.apply(this,arguments)}return __extends(Keystroke,_super),Keystroke.prototype._init=function(){var titleEnterHandler;return this.editor=this._module,this.editor.util.browser.safari&&this.editor.inputManager.addKeystrokeHandler("13","*",function(_this){return function(e){var $br;if(e.shiftKey)return $br=$("<br/>"),_this.editor.selection.rangeAtEndOf($blockEl)?(_this.editor.selection.insertNode($br),_this.editor.selection.insertNode($("<br/>")),_this.editor.selection.setRangeBefore($br)):_this.editor.selection.insertNode($br),!0}}(this)),(this.editor.util.browser.webkit||this.editor.util.browser.msie)&&(titleEnterHandler=function(_this){return function(e,$node){var $p;if(_this.editor.selection.rangeAtEndOf($node))return $p=$("<p/>").append(_this.editor.util.phBr).insertAfter($node),_this.editor.selection.setRangeAtStartOf($p),!0}}(this),this.editor.inputManager.addKeystrokeHandler("13","h1",titleEnterHandler),this.editor.inputManager.addKeystrokeHandler("13","h2",titleEnterHandler),this.editor.inputManager.addKeystrokeHandler("13","h3",titleEnterHandler),this.editor.inputManager.addKeystrokeHandler("13","h4",titleEnterHandler),this.editor.inputManager.addKeystrokeHandler("13","h5",titleEnterHandler),this.editor.inputManager.addKeystrokeHandler("13","h6",titleEnterHandler)),this.editor.inputManager.addKeystrokeHandler("8","*",function(_this){return function(){var $prevBlockEl,$rootBlock;return $rootBlock=_this.editor.util.furthestBlockEl(),$prevBlockEl=$rootBlock.prev(),$prevBlockEl.is("hr")&&_this.editor.selection.rangeAtStartOf($rootBlock)?(_this.editor.selection.save(),$prevBlockEl.remove(),_this.editor.selection.restore(),!0):void 0}}(this)),this.editor.inputManager.addKeystrokeHandler("9","*",function(_this){return function(e){return _this.editor.opts.tabIndent?(e.shiftKey?_this.editor.util.outdent():_this.editor.util.indent(),!0):void 0}}(this)),this.editor.inputManager.addKeystrokeHandler("13","li",function(_this){return function(e,$node){var $cloneNode,listEl,newBlockEl,newListEl;if($cloneNode=$node.clone(),$cloneNode.find("ul, ol").remove(),_this.editor.util.isEmptyNode($cloneNode)&&$node.is(_this.editor.util.closestBlockEl())){if(listEl=$node.parent(),$node.next("li").length>0){if(!_this.editor.util.isEmptyNode($node))return;listEl.parent("li").length>0?(newBlockEl=$("<li/>").append(_this.editor.util.phBr).insertAfter(listEl.parent("li")),newListEl=$("<"+listEl[0].tagName+"/>").append($node.nextAll("li")),newBlockEl.append(newListEl)):(newBlockEl=$("<p/>").append(_this.editor.util.phBr).insertAfter(listEl),newListEl=$("<"+listEl[0].tagName+"/>").append($node.nextAll("li")),newBlockEl.after(newListEl))}else listEl.parent("li").length>0?(newBlockEl=$("<li/>").insertAfter(listEl.parent("li")),newBlockEl.append($node.contents().length>0?$node.contents():_this.editor.util.phBr)):(newBlockEl=$("<p/>").append(_this.editor.util.phBr).insertAfter(listEl),$node.children("ul, ol").length>0&&newBlockEl.after($node.children("ul, ol")));return $node.prev("li").length?$node.remove():listEl.remove(),_this.editor.selection.setRangeAtStartOf(newBlockEl),!0}}}(this)),this.editor.inputManager.addKeystrokeHandler("13","pre",function(_this){return function(e,$node){var $p,breakNode,range;return e.preventDefault(),e.shiftKey?($p=$("<p/>").append(_this.editor.util.phBr).insertAfter($node),_this.editor.selection.setRangeAtStartOf($p),!0):(range=_this.editor.selection.getRange(),breakNode=null,range.deleteContents(),!_this.editor.util.browser.msie&&_this.editor.selection.rangeAtEndOf($node)?(breakNode=document.createTextNode("\n\n"),range.insertNode(breakNode),range.setEnd(breakNode,1)):(breakNode=document.createTextNode("\n"),range.insertNode(breakNode),range.setStartAfter(breakNode)),range.collapse(!1),_this.editor.selection.selectRange(range),!0)}}(this)),this.editor.inputManager.addKeystrokeHandler("13","blockquote",function(_this){return function(e,$node){var $closestBlock;return $closestBlock=_this.editor.util.closestBlockEl(),$closestBlock.is("p")&&!$closestBlock.next().length&&_this.editor.util.isEmptyNode($closestBlock)?($node.after($closestBlock),_this.editor.selection.setRangeAtStartOf($closestBlock),!0):void 0}}(this)),this.editor.inputManager.addKeystrokeHandler("8","li",function(_this){return function(e,$node){var $br,$childList,$newLi,$prevChildList,$prevNode,$textNode,range,text;return $childList=$node.children("ul, ol"),$prevNode=$node.prev("li"),$childList.length>0&&$prevNode.length>0?(text="",$textNode=null,$node.contents().each(function(i,n){if(1===n.nodeType&&/UL|OL/.test(n.nodeName))return!1;if(1!==n.nodeType||!/BR/.test(n.nodeName))return 3===n.nodeType&&n.nodeValue?text+=n.nodeValue:1===n.nodeType&&(text+=$(n).text()),$textNode=$(n)}),$textNode&&1===text.length&&_this.editor.util.browser.firefox&&!$textNode.next("br").length?($br=$(_this.editor.util.phBr).insertAfter($textNode),$textNode.remove(),_this.editor.selection.setRangeBefore($br),!0):text.length>0?!1:(range=document.createRange(),$prevChildList=$prevNode.children("ul, ol"),$prevChildList.length>0?($newLi=$("<li/>").append(_this.editor.util.phBr).appendTo($prevChildList),$prevChildList.append($childList.children("li")),$node.remove(),_this.editor.selection.setRangeAtEndOf($newLi,range)):(_this.editor.selection.setRangeAtEndOf($prevNode,range),$prevNode.append($childList),$node.remove(),_this.editor.selection.selectRange(range)),!0)):!1}}(this)),this.editor.inputManager.addKeystrokeHandler("8","pre",function(_this){return function(e,$node){var $newNode,codeStr;if(_this.editor.selection.rangeAtStartOf($node))return codeStr=$node.html().replace("\n","<br/>"),$newNode=$("<p/>").append(codeStr||_this.editor.util.phBr).insertAfter($node),$node.remove(),_this.editor.selection.setRangeAtStartOf($newNode),!0}}(this)),this.editor.inputManager.addKeystrokeHandler("8","blockquote",function(_this){return function(e,$node){var $firstChild;if(_this.editor.selection.rangeAtStartOf($node))return $firstChild=$node.children().first().unwrap(),_this.editor.selection.setRangeAtStartOf($firstChild),!0}}(this))},Keystroke}(SimpleModule);var UndoManager,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};UndoManager=function(_super){function UndoManager(){return UndoManager.__super__.constructor.apply(this,arguments)}return __extends(UndoManager,_super),UndoManager.className="UndoManager",UndoManager.prototype._index=-1,UndoManager.prototype._capacity=50,UndoManager.prototype._timer=null,UndoManager.prototype._init=function(){var redoShortcut,undoShortcut;return this.editor=this._module,this._stack=[],this.editor.util.os.mac?(undoShortcut="cmd+90",redoShortcut="shift+cmd+90"):this.editor.util.os.win?(undoShortcut="ctrl+90",redoShortcut="ctrl+89"):(undoShortcut="ctrl+90",redoShortcut="shift+ctrl+90"),this.editor.inputManager.addShortcut(undoShortcut,function(_this){return function(e){return e.preventDefault(),_this.undo(),!1}}(this)),this.editor.inputManager.addShortcut(redoShortcut,function(_this){return function(e){return e.preventDefault(),_this.redo(),!1}}(this)),this.editor.on("valuechanged",function(_this){return function(e,src){return"undo"!==src?(_this._timer&&(clearTimeout(_this._timer),_this._timer=null),_this._timer=setTimeout(function(){return _this._pushUndoState()
},200)):void 0}}(this))},UndoManager.prototype._pushUndoState=function(){var currentState,html;if(this.editor.triggerHandler("pushundostate")!==!1&&(currentState=this.currentState(),html=this.editor.body.html(),!currentState||currentState.html!==html))return this._index+=1,this._stack.length=this._index,this._stack.push({html:html,caret:this.caretPosition()}),this._stack.length>this._capacity?(this._stack.shift(),this._index-=1):void 0},UndoManager.prototype.currentState=function(){return this._stack.length&&this._index>-1?this._stack[this._index]:null},UndoManager.prototype.undo=function(){var state;if(!(this._index<1||this._stack.length<2))return this.editor.hidePopover(),this._index-=1,state=this._stack[this._index],this.editor.body.html(state.html),this.caretPosition(state.caret),this.editor.body.find(".selected").removeClass("selected"),this.editor.sync(),this.editor.trigger("valuechanged",["undo"])},UndoManager.prototype.redo=function(){var state;if(!(this._index<0||this._stack.length<this._index+2))return this.editor.hidePopover(),this._index+=1,state=this._stack[this._index],this.editor.body.html(state.html),this.caretPosition(state.caret),this.editor.body.find(".selected").removeClass("selected"),this.editor.sync(),this.editor.trigger("valuechanged",["undo"])},UndoManager.prototype.update=function(){var currentState,html;if(!this._timer&&(currentState=this.currentState()))return html=this.editor.body.html(),currentState.html=html,currentState.caret=this.caretPosition()},UndoManager.prototype._getNodeOffset=function(node,index){var $parent,merging,offset;return $parent=index?$(node):$(node).parent(),offset=0,merging=!1,$parent.contents().each(function(){return function(i,child){return index===i||node===child?!1:(3===child.nodeType?merging||(offset+=1,merging=!0):(offset+=1,merging=!1),null)}}(this)),offset},UndoManager.prototype._getNodePosition=function(node,offset){var position,prevNode;if(3===node.nodeType)for(prevNode=node.previousSibling;prevNode&&3===prevNode.nodeType;)node=prevNode,offset+=this.editor.util.getNodeLength(prevNode),prevNode=prevNode.previousSibling;else offset=this._getNodeOffset(node,offset);return position=[],position.unshift(offset),this.editor.util.traverseUp(function(_this){return function(n){return position.unshift(_this._getNodeOffset(n))}}(this),node),position},UndoManager.prototype._getNodeByPosition=function(position){var child,childNodes,i,node,offset,_i,_len,_ref;for(node=this.editor.body[0],_ref=position.slice(0,position.length-1),i=_i=0,_len=_ref.length;_len>_i;i=++_i){if(offset=_ref[i],childNodes=node.childNodes,offset>childNodes.length-1){if(i!==position.length-2||!$(node).is("pre")){node=null;break}child=document.createTextNode(""),node.appendChild(child),childNodes=node.childNodes}node=childNodes[offset]}return node},UndoManager.prototype.caretPosition=function(caret){var endContainer,endOffset,range,startContainer,startOffset;if(caret){if(this.editor.inputManager.focused||this.editor.body.focus(),!caret.start)return void this.editor.body.blur();if(startContainer=this._getNodeByPosition(caret.start),startOffset=caret.start[caret.start.length-1],caret.collapsed?(endContainer=startContainer,endOffset=startOffset):(endContainer=this._getNodeByPosition(caret.end),endOffset=caret.start[caret.start.length-1]),!startContainer||!endContainer)throw new Error("simditor: invalid caret state");return range=document.createRange(),range.setStart(startContainer,startOffset),range.setEnd(endContainer,endOffset),this.editor.selection.selectRange(range)}return range=this.editor.selection.getRange(),this.editor.inputManager.focused&&null!=range?(caret={start:[],end:null,collapsed:!0},caret.start=this._getNodePosition(range.startContainer,range.startOffset),range.collapsed||(caret.end=this._getNodePosition(range.endContainer,range.endOffset),caret.collapsed=!1),caret):{}},UndoManager}(SimpleModule);var Util,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};Util=function(_super){function Util(){return Util.__super__.constructor.apply(this,arguments)}return __extends(Util,_super),Util.className="Util",Util.prototype._init=function(){return this.editor=this._module,this.browser.msie&&this.browser.version<11?this.phBr="":void 0},Util.prototype.phBr="<br/>",Util.prototype.os=function(){var os;return os={},/Mac/.test(navigator.appVersion)?os.mac=!0:/Linux/.test(navigator.appVersion)?os.linux=!0:/Win/.test(navigator.appVersion)?os.win=!0:/X11/.test(navigator.appVersion)&&(os.unix=!0),/Mobi/.test(navigator.appVersion)&&(os.mobile=!0),os}(),Util.prototype.browser=function(){var chrome,firefox,ie,safari,ua;return ua=navigator.userAgent,ie=/(msie|trident)/i.test(ua),chrome=/chrome|crios/i.test(ua),safari=/safari/i.test(ua)&&!chrome,firefox=/firefox/i.test(ua),ie?{msie:!0,version:1*ua.match(/(msie |rv:)(\d+(\.\d+)?)/i)[2]}:chrome?{webkit:!0,chrome:!0,version:1*ua.match(/(?:chrome|crios)\/(\d+(\.\d+)?)/i)[1]}:safari?{webkit:!0,safari:!0,version:1*ua.match(/version\/(\d+(\.\d+)?)/i)[1]}:firefox?{mozilla:!0,firefox:!0,version:1*ua.match(/firefox\/(\d+(\.\d+)?)/i)[1]}:{}}(),Util.prototype.supportSelectionChange=function(){var e,onselectionchange;if(onselectionchange=document.onselectionchange,void 0!==onselectionchange)try{return document.onselectionchange=0,null===document.onselectionchange}catch(_error){e=_error}finally{document.onselectionchange=onselectionchange}return!1}(),Util.prototype.reflow=function(el){return null==el&&(el=document),$(el)[0].offsetHeight},Util.prototype.metaKey=function(e){var isMac;return isMac=/Mac/.test(navigator.userAgent),isMac?e.metaKey:e.ctrlKey},Util.prototype.isEmptyNode=function(node){var $node;return $node=$(node),$node.is(":empty")||!$node.text()&&!$node.find(":not(br, span, div)").length},Util.prototype.isBlockNode=function(node){return node=$(node)[0],node&&3!==node.nodeType?/^(div|p|ul|ol|li|blockquote|hr|pre|h1|h2|h3|h4|table)$/.test(node.nodeName.toLowerCase()):!1},Util.prototype.closestBlockEl=function(node){var $node,blockEl,range;return null==node&&(range=this.editor.selection.getRange(),node=null!=range?range.commonAncestorContainer:void 0),$node=$(node),$node.length?(blockEl=$node.parentsUntil(this.editor.body).addBack(),blockEl=blockEl.filter(function(_this){return function(i){return _this.isBlockNode(blockEl.eq(i))}}(this)),blockEl.length?blockEl.last():null):null},Util.prototype.furthestNode=function(node,filter){var $node,blockEl,range;return null==node&&(range=this.editor.selection.getRange(),node=null!=range?range.commonAncestorContainer:void 0),$node=$(node),$node.length?(blockEl=$node.parentsUntil(this.editor.body).addBack(),blockEl=blockEl.filter(function(){return function(i){var $n;return $n=blockEl.eq(i),$.isFunction(filter)?filter($n):$n.is(filter)}}(this)),blockEl.length?blockEl.first():null):null},Util.prototype.furthestBlockEl=function(node){return this.furthestNode(node,this.isBlockNode)},Util.prototype.getNodeLength=function(node){switch(node.nodeType){case 7:case 10:return 0;case 3:case 8:return node.length;default:return node.childNodes.length}},Util.prototype.traverseUp=function(callback,node){var n,nodes,range,result,_i,_len,_results;if(null==node&&(range=this.editor.selection.getRange(),node=null!=range?range.commonAncestorContainer:void 0),null==node||!$.contains(this.editor.body[0],node))return!1;for(nodes=$(node).parentsUntil(this.editor.body).get(),nodes.unshift(node),_results=[],_i=0,_len=nodes.length;_len>_i&&(n=nodes[_i],result=callback(n),result!==!1);_i++)_results.push(void 0);return _results},Util.prototype.getShortcutKey=function(e){var shortcutName;return shortcutName=[],e.shiftKey&&shortcutName.push("shift"),e.ctrlKey&&shortcutName.push("ctrl"),e.altKey&&shortcutName.push("alt"),e.metaKey&&shortcutName.push("cmd"),shortcutName.push(e.which),shortcutName.join("+")},Util.prototype.indent=function(){var $blockEl,$childList,$nextTd,$parentLi,$td,indentLevel,range,spaceNode,tagName,_ref;if($blockEl=this.editor.util.closestBlockEl(),!($blockEl&&$blockEl.length>0))return!1;if($blockEl.is("pre"))spaceNode=document.createTextNode("  "),this.editor.selection.insertNode(spaceNode);else if($blockEl.is("li")){if($parentLi=$blockEl.prev("li"),$parentLi.length<1)return!1;this.editor.selection.save(),tagName=$blockEl.parent()[0].tagName,$childList=$parentLi.children("ul, ol"),$childList.length>0?$childList.append($blockEl):$("<"+tagName+"/>").append($blockEl).appendTo($parentLi),this.editor.selection.restore()}else if($blockEl.is("p, h1, h2, h3, h4"))indentLevel=null!=(_ref=$blockEl.attr("data-indent"))?_ref:0,indentLevel=1*indentLevel+1,indentLevel>10&&(indentLevel=10),$blockEl.attr("data-indent",indentLevel);else if($blockEl.is("table")){if(range=this.editor.selection.getRange(),$td=$(range.commonAncestorContainer).closest("td"),$nextTd=$td.next("td"),$nextTd.length>0||($nextTd=$td.parent("tr").next("tr").find("td:first")),!($td.length>0&&$nextTd.length>0))return!1;this.editor.selection.setRangeAtEndOf($nextTd)}else spaceNode=document.createTextNode("    "),this.editor.selection.insertNode(spaceNode);return this.editor.trigger("valuechanged"),!0},Util.prototype.outdent=function(){var $blockEl,$parent,$parentLi,$prevTd,$td,button,indentLevel,range,_ref;if($blockEl=this.editor.util.closestBlockEl(),!($blockEl&&$blockEl.length>0))return!1;if($blockEl.is("pre"))return!1;if($blockEl.is("li")){if($parent=$blockEl.parent(),$parentLi=$parent.parent("li"),$parentLi.length<1)return button=this.editor.toolbar.findButton($parent[0].tagName.toLowerCase()),null!=button&&button.command(),!1;this.editor.selection.save(),$blockEl.next("li").length>0&&$("<"+$parent[0].tagName+"/>").append($blockEl.nextAll("li")).appendTo($blockEl),$blockEl.insertAfter($parentLi),$parent.children("li").length<1&&$parent.remove(),this.editor.selection.restore()}else if($blockEl.is("p, h1, h2, h3, h4"))indentLevel=null!=(_ref=$blockEl.attr("data-indent"))?_ref:0,indentLevel=1*indentLevel-1,0>indentLevel&&(indentLevel=0),$blockEl.attr("data-indent",indentLevel);else{if(!$blockEl.is("table"))return!1;if(range=this.editor.selection.getRange(),$td=$(range.commonAncestorContainer).closest("td"),$prevTd=$td.prev("td"),$prevTd.length>0||($prevTd=$td.parent("tr").prev("tr").find("td:last")),!($td.length>0&&$prevTd.length>0))return!1;this.editor.selection.setRangeAtEndOf($prevTd)}return this.editor.trigger("valuechanged"),!0},Util.prototype.dataURLtoBlob=function(dataURL){var BlobBuilder,arrayBuffer,bb,byteString,hasArrayBufferViewSupport,hasBlobConstructor,i,intArray,mimeString,_i,_ref;if(hasBlobConstructor=window.Blob&&function(){var e;try{return Boolean(new Blob)}catch(_error){return e=_error,!1}}(),hasArrayBufferViewSupport=hasBlobConstructor&&window.Uint8Array&&function(){var e;try{return 100===new Blob([new Uint8Array(100)]).size}catch(_error){return e=_error,!1}}(),BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,!((hasBlobConstructor||BlobBuilder)&&window.atob&&window.ArrayBuffer&&window.Uint8Array))return!1;for(byteString=dataURL.split(",")[0].indexOf("base64")>=0?atob(dataURL.split(",")[1]):decodeURIComponent(dataURL.split(",")[1]),arrayBuffer=new ArrayBuffer(byteString.length),intArray=new Uint8Array(arrayBuffer),i=_i=0,_ref=byteString.length;_ref>=0?_ref>=_i:_i>=_ref;i=_ref>=0?++_i:--_i)intArray[i]=byteString.charCodeAt(i);return mimeString=dataURL.split(",")[0].split(":")[1].split(";")[0],hasBlobConstructor?new Blob([hasArrayBufferViewSupport?intArray:arrayBuffer],{type:mimeString}):(bb=new BlobBuilder,bb.append(arrayBuffer),bb.getBlob(mimeString))},Util}(SimpleModule);var Toolbar,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};Toolbar=function(_super){function Toolbar(){return Toolbar.__super__.constructor.apply(this,arguments)}return __extends(Toolbar,_super),Toolbar.className="Toolbar",Toolbar.prototype.opts={toolbar:!0,toolbarFloat:!0,toolbarHidden:!1},Toolbar.prototype._tpl={wrapper:'<div class="simditor-toolbar"><ul></ul></div>',separator:'<li><span class="separator"></span></li>'},Toolbar.prototype._init=function(){var toolbarHeight;return this.editor=this._module,this.opts.toolbar?($.isArray(this.opts.toolbar)||(this.opts.toolbar=["bold","italic","underline","strikethrough","|","ol","ul","blockquote","code","|","link","image","|","indent","outdent"]),this._render(),this.list.on("click",function(){return function(){return!1}}(this)),this.wrapper.on("mousedown",function(_this){return function(){return _this.list.find(".menu-on").removeClass(".menu-on")}}(this)),$(document).on("mousedown.simditor"+this.editor.id,function(_this){return function(){return _this.list.find(".menu-on").removeClass(".menu-on")}}(this)),!this.opts.toolbarHidden&&this.opts.toolbarFloat&&(this.wrapper.width(this.wrapper.outerWidth()),toolbarHeight=this.wrapper.outerHeight(),this.editor.util.os.mobile||$(window).on("resize.simditor-"+this.editor.id,function(_this){return function(){return _this.wrapper.css("position","static"),_this.editor.util.reflow(_this.wrapper),_this.wrapper.css("left",_this.wrapper.offset().left),_this.wrapper.css("position","")}}(this)).resize(),$(window).on("scroll.simditor-"+this.editor.id,function(_this){return function(){var bottomEdge,scrollTop,topEdge;if(topEdge=_this.editor.wrapper.offset().top,bottomEdge=topEdge+_this.editor.wrapper.outerHeight()-80,scrollTop=$(document).scrollTop(),topEdge>=scrollTop||scrollTop>=bottomEdge){if(_this.editor.wrapper.removeClass("toolbar-floating").css("padding-top",""),_this.editor.util.os.mobile)return _this.wrapper.css({top:"auto"})}else if(_this.editor.wrapper.addClass("toolbar-floating").css("padding-top",toolbarHeight),_this.editor.util.os.mobile)return _this.wrapper.css({top:scrollTop-topEdge})}}(this))),this.editor.on("selectionchanged",function(_this){return function(){return _this.toolbarStatus()}}(this)),this.editor.on("destroy",function(_this){return function(){return _this.buttons.length=0}}(this)),$(document).on("mousedown.simditor-"+this.editor.id,function(_this){return function(){return _this.list.find("li.menu-on").removeClass("menu-on")}}(this))):void 0},Toolbar.prototype._render=function(){var name,_i,_len,_ref;for(this.buttons=[],this.wrapper=$(this._tpl.wrapper).prependTo(this.editor.wrapper),this.list=this.wrapper.find("ul"),_ref=this.opts.toolbar,_i=0,_len=_ref.length;_len>_i;_i++)if(name=_ref[_i],"|"!==name){if(!this.constructor.buttons[name])throw new Error('simditor: invalid toolbar button "'+name+'"');this.buttons.push(new this.constructor.buttons[name]({editor:this.editor}))}else $(this._tpl.separator).appendTo(this.list);return this.opts.toolbarHidden?this.wrapper.hide():this.editor.placeholderEl.css("top",this.wrapper.outerHeight())},Toolbar.prototype.toolbarStatus=function(name){var buttons;if(this.editor.inputManager.focused)return buttons=this.buttons.slice(0),this.editor.util.traverseUp(function(){return function(node){var button,i,removeButtons,_i,_j,_len,_len1;for(removeButtons=[],i=_i=0,_len=buttons.length;_len>_i;i=++_i)button=buttons[i],(null==name||button.name===name)&&(button.status&&button.status($(node))!==!0||removeButtons.push(button));for(_j=0,_len1=removeButtons.length;_len1>_j;_j++)button=removeButtons[_j],i=$.inArray(button,buttons),buttons.splice(i,1);return 0===buttons.length?!1:void 0}}(this))},Toolbar.prototype.findButton=function(name){var button;return button=this.list.find(".toolbar-item-"+name).data("button"),null!=button?button:null},Toolbar.addButton=function(btn){return this.buttons[btn.prototype.name]=btn},Toolbar.buttons={},Toolbar}(SimpleModule);var Simditor,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};Simditor=function(_super){function Simditor(){return Simditor.__super__.constructor.apply(this,arguments)}return __extends(Simditor,_super),Simditor.connect(Util),Simditor.connect(InputManager),Simditor.connect(UndoManager),Simditor.connect(Keystroke),Simditor.connect(Formatter),Simditor.connect(Selection),Simditor.connect(Toolbar),Simditor.count=0,Simditor.prototype.opts={textarea:null,placeholder:"",defaultImage:"images/image.png",params:{},upload:!1,tabIndent:!0},Simditor.prototype._init=function(){var editor,form,uploadOpts;if(this.textarea=$(this.opts.textarea),this.opts.placeholder=this.opts.placeholder||this.textarea.attr("placeholder"),!this.textarea.length)throw new Error("simditor: param textarea is required.");return editor=this.textarea.data("simditor"),null!=editor&&editor.destroy(),this.id=++Simditor.count,this._render(),this.opts.upload&&simpleUploader&&(uploadOpts="object"==typeof this.opts.upload?this.opts.upload:{},this.uploader=simpleUploader(uploadOpts)),form=this.textarea.closest("form"),form.length&&(form.on("submit.simditor-"+this.id,function(_this){return function(){return _this.sync()}}(this)),form.on("reset.simditor-"+this.id,function(_this){return function(){return _this.setValue("")}}(this))),this.on("initialized",function(_this){return function(){return _this.opts.placeholder&&_this.on("valuechanged",function(){return _this._placeholder()}),_this.setValue(_this.textarea.val()||"")}}(this)),this.util.browser.mozilla?(document.execCommand("enableObjectResizing",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1)):void 0},Simditor.prototype._tpl='<div class="simditor">\n  <div class="simditor-wrapper">\n    <div class="simditor-placeholder"></div>\n    <div class="simditor-body" contenteditable="true">\n    </div>\n  </div>\n</div>',Simditor.prototype._render=function(){var key,val,_ref,_results;if(this.el=$(this._tpl).insertBefore(this.textarea),this.wrapper=this.el.find(".simditor-wrapper"),this.body=this.wrapper.find(".simditor-body"),this.placeholderEl=this.wrapper.find(".simditor-placeholder").append(this.opts.placeholder),this.el.append(this.textarea).data("simditor",this),this.textarea.data("simditor",this).hide().blur(),this.body.attr("tabindex",this.textarea.attr("tabindex")),this.util.os.mac?this.el.addClass("simditor-mac"):this.util.os.linux&&this.el.addClass("simditor-linux"),this.util.os.mobile&&this.el.addClass("simditor-mobile"),this.opts.params){_ref=this.opts.params,_results=[];for(key in _ref)val=_ref[key],_results.push($("<input/>",{type:"hidden",name:key,value:val}).insertAfter(this.textarea));return _results}},Simditor.prototype._placeholder=function(){var children,_ref;return children=this.body.children(),0===children.length||1===children.length&&this.util.isEmptyNode(children)&&(null!=(_ref=children.data("indent"))?_ref:0)<1?this.placeholderEl.show():this.placeholderEl.hide()},Simditor.prototype.setValue=function(val){return this.hidePopover(),this.textarea.val(val),this.body.html(val),this.formatter.format(),this.formatter.decorate(),setTimeout(function(_this){return function(){return _this.trigger("valuechanged")}}(this),0)},Simditor.prototype.getValue=function(){return this.sync()},Simditor.prototype.sync=function(){var children,cloneBody,emptyP,firstP,lastP,val;for(this.hidePopover,cloneBody=this.body.clone(),this.formatter.undecorate(cloneBody),this.formatter.format(cloneBody),this.formatter.autolink(cloneBody),children=cloneBody.children(),lastP=children.last("p"),firstP=children.first("p");lastP.is("p")&&this.util.isEmptyNode(lastP);)emptyP=lastP,lastP=lastP.prev("p"),emptyP.remove();for(;firstP.is("p")&&this.util.isEmptyNode(firstP);)emptyP=firstP,firstP=lastP.next("p"),emptyP.remove();return cloneBody.find("img.uploading").remove(),val=$.trim(cloneBody.html()),this.textarea.val(val),val},Simditor.prototype.focus=function(){var $blockEl,range;if(this.inputManager.lastCaretPosition)return this.undoManager.caretPosition(this.inputManager.lastCaretPosition);if($blockEl=this.body.find("p, li, pre, h1, h2, h3, h4, td").first(),$blockEl.length>0)return range=document.createRange(),this.selection.setRangeAtStartOf($blockEl,range),this.body.focus()},Simditor.prototype.blur=function(){return this.body.blur()},Simditor.prototype.hidePopover=function(){return this.el.find(".simditor-popover").each(function(){return function(i,popover){return popover=$(popover).data("popover"),popover.active?popover.hide():void 0}}(this))},Simditor.prototype.destroy=function(){return this.triggerHandler("destroy"),this.textarea.closest("form").off(".simditor .simditor-"+this.id),this.selection.clear(),this.textarea.insertBefore(this.el).hide().val("").removeData("simditor"),this.el.remove(),$(document).off(".simditor-"+this.id),$(window).off(".simditor-"+this.id),this.off()},Simditor}(SimpleModule),Simditor.i18n={"zh-CN":{blockquote:"引用",bold:"加粗文字",code:"插入代码",color:"文字颜色",hr:"分隔线",insertImage:"插入图片",localImage:"本地图片",externalImage:"外链图片",uploadImage:"上传图片",uploadFailed:"上传失败了",uploadError:"上传出错了",imageUrl:"图片地址",imageSize:"图片尺寸",restoreImageSize:"还原图片尺寸",uploading:"正在上传",indent:"向右缩进",outdent:"向左缩进",italic:"斜体文字",insertLink:"插入链接",text:"文本",linkText:"链接文字",linkUrl:"地址",removeLink:"移除链接",ol:"有序列表",ul:"无序列表",strikethrough:"删除线文字",table:"表格",deleteRow:"删除行",insertRowAbove:"在上面插入行",insertRowBelow:"在下面插入行",deleteColumn:"删除列",insertColumnLeft:"在左边插入列",insertColumnRight:"在右边插入列",deleteTable:"删除表格",title:"标题",normalText:"普通文本",underline:"下划线文字"}};var Button,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};Button=function(_super){function Button(opts){this.editor=opts.editor,Button.__super__.constructor.call(this,opts)}return __extends(Button,_super),Button.prototype._tpl={item:'<li><a tabindex="-1" unselectable="on" class="toolbar-item" href="javascript:;"><span></span></a></li>',menuWrapper:'<div class="toolbar-menu"></div>',menuItem:'<li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;"><span></span></a></li>',separator:'<li><span class="separator"></span></li>'},Button.prototype.name="",Button.prototype.icon="",Button.prototype.title="",Button.prototype.text="",Button.prototype.htmlTag="",Button.prototype.disableTag="",Button.prototype.menu=!1,Button.prototype.active=!1,Button.prototype.disabled=!1,Button.prototype.needFocus=!0,Button.prototype.shortcut=null,Button.prototype._init=function(){var tag,_i,_len,_ref,_results;for(this.render(),this.el.on("mousedown",function(_this){return function(e){var exceed,param;return e.preventDefault(),_this.el.hasClass("disabled")||_this.needFocus&&!_this.editor.inputManager.focused?!1:_this.menu?(_this.wrapper.toggleClass("menu-on").siblings("li").removeClass("menu-on"),_this.wrapper.is(".menu-on")&&(exceed=_this.menuWrapper.offset().left+_this.menuWrapper.outerWidth()+5-_this.editor.wrapper.offset().left-_this.editor.wrapper.outerWidth(),exceed>0&&_this.menuWrapper.css({left:"auto",right:0}),_this.trigger("menuexpand")),!1):(param=_this.el.data("param"),_this.command(param),!1)}}(this)),this.wrapper.on("click","a.menu-item",function(_this){return function(e){var btn,param;return e.preventDefault(),btn=$(e.currentTarget),_this.wrapper.removeClass("menu-on"),btn.hasClass("disabled")||_this.needFocus&&!_this.editor.inputManager.focused?!1:(_this.editor.toolbar.wrapper.removeClass("menu-on"),param=btn.data("param"),_this.command(param),!1)}}(this)),this.wrapper.on("mousedown","a.menu-item",function(){return function(){return!1}}(this)),this.editor.on("blur",function(_this){return function(){return _this.setActive(!1),_this.setDisabled(!1)}}(this)),null!=this.shortcut&&this.editor.inputManager.addShortcut(this.shortcut,function(_this){return function(){return _this.el.mousedown(),!1}}(this)),_ref=this.htmlTag.split(","),_results=[],_i=0,_len=_ref.length;_len>_i;_i++)tag=_ref[_i],tag=$.trim(tag),_results.push(tag&&$.inArray(tag,this.editor.formatter._allowedTags)<0?this.editor.formatter._allowedTags.push(tag):void 0);return _results},Button.prototype.render=function(){return this.wrapper=$(this._tpl.item).appendTo(this.editor.toolbar.list),this.el=this.wrapper.find("a.toolbar-item"),this.el.attr("title",this.title).addClass("toolbar-item-"+this.name).data("button",this),this.el.find("span").addClass(this.icon?"fa fa-"+this.icon:"").text(this.text),this.menu?(this.menuWrapper=$(this._tpl.menuWrapper).appendTo(this.wrapper),this.menuWrapper.addClass("toolbar-menu-"+this.name),this.renderMenu()):void 0},Button.prototype.renderMenu=function(){var $menuBtntnEl,$menuItemEl,menuItem,_i,_len,_ref,_ref1,_results;if($.isArray(this.menu)){for(this.menuEl=$("<ul/>").appendTo(this.menuWrapper),_ref=this.menu,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)menuItem=_ref[_i],"|"!==menuItem?($menuItemEl=$(this._tpl.menuItem).appendTo(this.menuEl),_results.push($menuBtntnEl=$menuItemEl.find("a.menu-item").attr({title:null!=(_ref1=menuItem.title)?_ref1:menuItem.text,"data-param":menuItem.param}).addClass("menu-item-"+menuItem.name).find("span").text(menuItem.text))):$(this._tpl.separator).appendTo(this.menuEl);return _results}},Button.prototype.setActive=function(active){return active!==this.active?(this.active=active,this.el.toggleClass("active",this.active),this.editor.toolbar.trigger("buttonstatus",[this])):void 0},Button.prototype.setDisabled=function(disabled){return disabled!==this.disabled?(this.disabled=disabled,this.el.toggleClass("disabled",this.disabled),this.editor.toolbar.trigger("buttonstatus",[this])):void 0},Button.prototype.status=function($node){return null!=$node&&this.setDisabled($node.is(this.disableTag)),this.disabled?!0:(null!=$node&&this.setActive($node.is(this.htmlTag)),this.active)},Button.prototype.command=function(){},Button}(SimpleModule),Simditor.Button=Button;var Popover,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};Popover=function(_super){function Popover(opts){this.button=opts.button,this.editor=opts.button.editor,Popover.__super__.constructor.call(this,opts)}return __extends(Popover,_super),Popover.prototype.offset={top:4,left:0},Popover.prototype.target=null,Popover.prototype.active=!1,Popover.prototype._init=function(){return this.el=$('<div class="simditor-popover"></div>').appendTo(this.editor.el).data("popover",this),this.render(),this.el.on("mouseenter",function(_this){return function(){return _this.el.addClass("hover")}}(this)),this.el.on("mouseleave",function(_this){return function(){return _this.el.removeClass("hover")}}(this))},Popover.prototype.render=function(){},Popover.prototype.show=function($target,position){return null==position&&(position="bottom"),null!=$target?(this.editor.hidePopover(),this.target=$target.addClass("selected"),this.active?(this.refresh(position),this.trigger("popovershow")):(this.active=!0,this.el.css({left:-9999}).show(),setTimeout(function(_this){return function(){return _this.refresh(position),_this.trigger("popovershow")}}(this),0))):void 0},Popover.prototype.hide=function(){return this.active?(this.target&&this.target.removeClass("selected"),this.target=null,this.active=!1,this.el.hide(),this.trigger("popoverhide")):void 0},Popover.prototype.refresh=function(position){var editorOffset,left,targetH,targetOffset,top;return null==position&&(position="bottom"),this.active?(editorOffset=this.editor.el.offset(),targetOffset=this.target.offset(),targetH=this.target.outerHeight(),"bottom"===position?top=targetOffset.top-editorOffset.top+targetH:"top"===position&&(top=targetOffset.top-editorOffset.top-this.el.height()),left=Math.min(targetOffset.left-editorOffset.left,this.editor.wrapper.width()-this.el.outerWidth()-10),this.el.css({top:top+this.offset.top,left:left+this.offset.left})):void 0},Popover.prototype.destroy=function(){return this.target=null,this.active=!1,this.editor.off(".linkpopover"),this.el.remove()},Popover}(SimpleModule),Simditor.Popover=Popover;var TitleButton,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};TitleButton=function(_super){function TitleButton(){return TitleButton.__super__.constructor.apply(this,arguments)}return __extends(TitleButton,_super),TitleButton.prototype.name="title",TitleButton.prototype.title=Simditor._t("title"),TitleButton.prototype.htmlTag="h1, h2, h3, h4",TitleButton.prototype.disableTag="pre, table",TitleButton.prototype.menu=[{name:"normal",text:Simditor._t("normalText"),param:"p"},"|",{name:"h1",text:Simditor._t("title")+" 1",param:"h1"},{name:"h2",text:Simditor._t("title")+" 2",param:"h2"},{name:"h3",text:Simditor._t("title")+" 3",param:"h3"}],TitleButton.prototype.setActive=function(active,param){return TitleButton.__super__.setActive.call(this,active),this.el.removeClass("active-p active-h1 active-h2 active-h3"),active?this.el.addClass("active active-"+param):void 0},TitleButton.prototype.status=function($node){var param,_ref;return null!=$node&&this.setDisabled($node.is(this.disableTag)),this.disabled?!0:(null!=$node&&(param=null!=(_ref=$node[0].tagName)?_ref.toLowerCase():void 0,this.setActive($node.is(this.htmlTag),param)),this.active)},TitleButton.prototype.command=function(param){var $contents,$endBlock,$startBlock,endNode,node,range,results,startNode,_i,_len,_ref;for(range=this.editor.selection.getRange(),startNode=range.startContainer,endNode=range.endContainer,$startBlock=this.editor.util.closestBlockEl(startNode),$endBlock=this.editor.util.closestBlockEl(endNode),this.editor.selection.save(),range.setStartBefore($startBlock[0]),range.setEndAfter($endBlock[0]),$contents=$(range.extractContents()),results=[],$contents.children().each(function(_this){return function(i,el){var c,converted,_i,_len,_results;for(converted=_this._convertEl(el,param),_results=[],_i=0,_len=converted.length;_len>_i;_i++)c=converted[_i],_results.push(results.push(c));return _results}}(this)),_ref=results.reverse(),_i=0,_len=_ref.length;_len>_i;_i++)node=_ref[_i],range.insertNode(node[0]);return this.editor.selection.restore(),this.editor.trigger("valuechanged")},TitleButton.prototype._convertEl=function(el,param){var $block,$el,results;return $el=$(el),results=[],$el.is(param)?results.push($el):($block=$("<"+param+"/>").append($el.contents()),results.push($block)),results},TitleButton}(Button),Simditor.Toolbar.addButton(TitleButton);var BoldButton,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};BoldButton=function(_super){function BoldButton(){return BoldButton.__super__.constructor.apply(this,arguments)}return __extends(BoldButton,_super),BoldButton.prototype.name="bold",BoldButton.prototype.icon="bold",BoldButton.prototype.title=Simditor._t("bold"),BoldButton.prototype.htmlTag="b, strong",BoldButton.prototype.disableTag="pre",BoldButton.prototype.shortcut="cmd+66",BoldButton.prototype.render=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + b )":(this.title=this.title+" ( Ctrl + b )",this.shortcut="ctrl+66"),BoldButton.__super__.render.call(this)
},BoldButton.prototype.status=function($node){var active;return null!=$node&&this.setDisabled($node.is(this.disableTag)),this.disabled?!0:(active=document.queryCommandState("bold")===!0,this.setActive(active),active)},BoldButton.prototype.command=function(){return document.execCommand("bold"),this.editor.trigger("valuechanged"),$(document).trigger("selectionchange")},BoldButton}(Button),Simditor.Toolbar.addButton(BoldButton);var ItalicButton,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};ItalicButton=function(_super){function ItalicButton(){return ItalicButton.__super__.constructor.apply(this,arguments)}return __extends(ItalicButton,_super),ItalicButton.prototype.name="italic",ItalicButton.prototype.icon="italic",ItalicButton.prototype.title=Simditor._t("italic"),ItalicButton.prototype.htmlTag="i",ItalicButton.prototype.disableTag="pre",ItalicButton.prototype.shortcut="cmd+73",ItalicButton.prototype.render=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + i )":(this.title=this.title+" ( Ctrl + i )",this.shortcut="ctrl+73"),ItalicButton.__super__.render.call(this)},ItalicButton.prototype.status=function($node){var active;return null!=$node&&this.setDisabled($node.is(this.disableTag)),this.disabled?this.disabled:(active=document.queryCommandState("italic")===!0,this.setActive(active),active)},ItalicButton.prototype.command=function(){return document.execCommand("italic"),this.editor.trigger("valuechanged"),$(document).trigger("selectionchange")},ItalicButton}(Button),Simditor.Toolbar.addButton(ItalicButton);var UnderlineButton,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};UnderlineButton=function(_super){function UnderlineButton(){return UnderlineButton.__super__.constructor.apply(this,arguments)}return __extends(UnderlineButton,_super),UnderlineButton.prototype.name="underline",UnderlineButton.prototype.icon="underline",UnderlineButton.prototype.title=Simditor._t("underline"),UnderlineButton.prototype.htmlTag="u",UnderlineButton.prototype.disableTag="pre",UnderlineButton.prototype.shortcut="cmd+85",UnderlineButton.prototype.render=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + u )":(this.title=this.title+" ( Ctrl + u )",this.shortcut="ctrl+85"),UnderlineButton.__super__.render.call(this)},UnderlineButton.prototype.status=function($node){var active;return null!=$node&&this.setDisabled($node.is(this.disableTag)),this.disabled?this.disabled:(active=document.queryCommandState("underline")===!0,this.setActive(active),active)},UnderlineButton.prototype.command=function(){return document.execCommand("underline"),this.editor.trigger("valuechanged"),$(document).trigger("selectionchange")},UnderlineButton}(Button),Simditor.Toolbar.addButton(UnderlineButton);var ColorButton,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__slice=[].slice;ColorButton=function(_super){function ColorButton(){return ColorButton.__super__.constructor.apply(this,arguments)}return __extends(ColorButton,_super),ColorButton.prototype.name="color",ColorButton.prototype.icon="font",ColorButton.prototype.title=Simditor._t("color"),ColorButton.prototype.disableTag="pre",ColorButton.prototype.menu=!0,ColorButton.prototype.render=function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],ColorButton.__super__.render.apply(this,args)},ColorButton.prototype.renderMenu=function(){return $('<ul class="color-list">\n  <li><a href="javascript:;" class="font-color font-color-1" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-2" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-3" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-4" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-5" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-6" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-7" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-default" data-color=""></a></li>\n</ul>').appendTo(this.menuWrapper),this.menuWrapper.on("mousedown",".color-list",function(){return!1}),this.menuWrapper.on("click",".font-color",function(_this){return function(e){var $link,$p,hex,rgb;if(_this.wrapper.removeClass("menu-on"),$link=$(e.currentTarget),$link.hasClass("font-color-default")){if($p=_this.editor.body.find("p, li"),!($p.length>0))return;rgb=window.getComputedStyle($p[0],null).getPropertyValue("color"),hex=_this._convertRgbToHex(rgb)}else rgb=window.getComputedStyle($link[0],null).getPropertyValue("background-color"),hex=_this._convertRgbToHex(rgb);return hex?(document.execCommand("foreColor",!1,hex),_this.editor.trigger("valuechanged")):void 0}}(this))},ColorButton.prototype._convertRgbToHex=function(rgb){var match,re,rgbToHex;return re=/rgb\((\d+),\s?(\d+),\s?(\d+)\)/g,(match=re.exec(rgb))?(rgbToHex=function(r,g,b){var componentToHex;return componentToHex=function(c){var hex;return hex=c.toString(16),1===hex.length?"0"+hex:hex},"#"+componentToHex(r)+componentToHex(g)+componentToHex(b)})(1*match[1],1*match[2],1*match[3]):""},ColorButton}(Button),Simditor.Toolbar.addButton(ColorButton);var ListButton,OrderListButton,UnorderListButton,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};ListButton=function(_super){function ListButton(){return ListButton.__super__.constructor.apply(this,arguments)}return __extends(ListButton,_super),ListButton.prototype.type="",ListButton.prototype.disableTag="pre, table",ListButton.prototype.status=function($node){var anotherType;return null!=$node&&this.setDisabled($node.is(this.disableTag)),this.disabled?!0:null==$node?this.active:(anotherType="ul"===this.type?"ol":"ul",$node.is(anotherType)?(this.setActive(!1),!0):(this.setActive($node.is(this.htmlTag)),this.active))},ListButton.prototype.command=function(){var $contents,$endBlock,$furthestEnd,$furthestStart,$parent,$startBlock,endLevel,endNode,getListLevel,node,range,results,startLevel,startNode,_i,_len,_ref;for(range=this.editor.selection.getRange(),startNode=range.startContainer,endNode=range.endContainer,$startBlock=this.editor.util.closestBlockEl(startNode),$endBlock=this.editor.util.closestBlockEl(endNode),this.editor.selection.save(),range.setStartBefore($startBlock[0]),range.setEndAfter($endBlock[0]),$startBlock.is("li")&&$endBlock.is("li")&&($furthestStart=this.editor.util.furthestNode($startBlock,"ul, ol"),$furthestEnd=this.editor.util.furthestNode($endBlock,"ul, ol"),$furthestStart.is($furthestEnd)?(getListLevel=function($li){var lvl;for(lvl=1;!$li.parent().is($furthestStart);)lvl+=1,$li=$li.parent();return lvl},startLevel=getListLevel($startBlock),endLevel=getListLevel($endBlock),$parent=startLevel>endLevel?$endBlock.parent():$startBlock.parent(),range.setStartBefore($parent[0]),range.setEndAfter($parent[0])):(range.setStartBefore($furthestStart[0]),range.setEndAfter($furthestEnd[0]))),$contents=$(range.extractContents()),results=[],$contents.children().each(function(_this){return function(i,el){var c,converted,_i,_len,_results;for(converted=_this._convertEl(el),_results=[],_i=0,_len=converted.length;_len>_i;_i++)c=converted[_i],_results.push(results.length&&results[results.length-1].is(_this.type)&&c.is(_this.type)?results[results.length-1].append(c.children()):results.push(c));return _results}}(this)),_ref=results.reverse(),_i=0,_len=_ref.length;_len>_i;_i++)node=_ref[_i],range.insertNode(node[0]);return this.editor.selection.restore(),this.editor.trigger("valuechanged")},ListButton.prototype._convertEl=function(el){var $el,anotherType,block,child,children,results,_i,_len,_ref;if($el=$(el),results=[],anotherType="ul"===this.type?"ol":"ul",$el.is(this.type))$el.children("li").each(function(_this){return function(i,li){var $childList,$li,block;return $li=$(li),$childList=$li.children("ul, ol").remove(),block=$("<p/>").append($(li).html()||_this.editor.util.phBr),results.push(block),$childList.length>0?results.push($childList):void 0}}(this));else if($el.is(anotherType))block=$("<"+this.type+"/>").append($el.html()),results.push(block);else if($el.is("blockquote")){for(_ref=$el.children().get(),_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],children=this._convertEl(child);$.merge(results,children)}else $el.is("table")||(block=$("<"+this.type+"><li></li></"+this.type+">"),block.find("li").append($el.html()||this.editor.util.phBr),results.push(block));return results},ListButton}(Button),OrderListButton=function(_super){function OrderListButton(){return OrderListButton.__super__.constructor.apply(this,arguments)}return __extends(OrderListButton,_super),OrderListButton.prototype.type="ol",OrderListButton.prototype.name="ol",OrderListButton.prototype.title=Simditor._t("ol"),OrderListButton.prototype.icon="list-ol",OrderListButton.prototype.htmlTag="ol",OrderListButton.prototype.shortcut="cmd+191",OrderListButton.prototype.render=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + / )":(this.title=this.title+" ( ctrl + / )",this.shortcut="ctrl+191"),OrderListButton.__super__.render.call(this)},OrderListButton}(ListButton),UnorderListButton=function(_super){function UnorderListButton(){return UnorderListButton.__super__.constructor.apply(this,arguments)}return __extends(UnorderListButton,_super),UnorderListButton.prototype.type="ul",UnorderListButton.prototype.name="ul",UnorderListButton.prototype.title=Simditor._t("ul"),UnorderListButton.prototype.icon="list-ul",UnorderListButton.prototype.htmlTag="ul",UnorderListButton.prototype.shortcut="cmd+190",UnorderListButton.prototype.render=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + . )":(this.title=this.title+" ( Ctrl + . )",this.shortcut="ctrl+190"),UnorderListButton.__super__.render.call(this)},UnorderListButton}(ListButton),Simditor.Toolbar.addButton(OrderListButton),Simditor.Toolbar.addButton(UnorderListButton);var BlockquoteButton,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};BlockquoteButton=function(_super){function BlockquoteButton(){return BlockquoteButton.__super__.constructor.apply(this,arguments)}return __extends(BlockquoteButton,_super),BlockquoteButton.prototype.name="blockquote",BlockquoteButton.prototype.icon="quote-left",BlockquoteButton.prototype.title=Simditor._t("blockquote"),BlockquoteButton.prototype.htmlTag="blockquote",BlockquoteButton.prototype.disableTag="pre, table",BlockquoteButton.prototype.command=function(){var $contents,$endBlock,$startBlock,endNode,node,range,results,startNode,_i,_len,_ref;for(range=this.editor.selection.getRange(),startNode=range.startContainer,endNode=range.endContainer,$startBlock=this.editor.util.furthestBlockEl(startNode),$endBlock=this.editor.util.furthestBlockEl(endNode),this.editor.selection.save(),range.setStartBefore($startBlock[0]),range.setEndAfter($endBlock[0]),$contents=$(range.extractContents()),results=[],$contents.children().each(function(_this){return function(i,el){var c,converted,_i,_len,_results;for(converted=_this._convertEl(el),_results=[],_i=0,_len=converted.length;_len>_i;_i++)c=converted[_i],_results.push(results.length&&results[results.length-1].is(_this.htmlTag)&&c.is(_this.htmlTag)?results[results.length-1].append(c.children()):results.push(c));return _results}}(this)),_ref=results.reverse(),_i=0,_len=_ref.length;_len>_i;_i++)node=_ref[_i],range.insertNode(node[0]);return this.editor.selection.restore(),this.editor.trigger("valuechanged")},BlockquoteButton.prototype._convertEl=function(el){var $el,block,results;return $el=$(el),results=[],$el.is(this.htmlTag)?$el.children().each(function(){return function(i,node){return results.push($(node))}}(this)):(block=$("<"+this.htmlTag+"/>").append($el),results.push(block)),results},BlockquoteButton}(Button),Simditor.Toolbar.addButton(BlockquoteButton);var CodeButton,CodePopover,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__slice=[].slice;CodeButton=function(_super){function CodeButton(){return CodeButton.__super__.constructor.apply(this,arguments)}return __extends(CodeButton,_super),CodeButton.prototype.name="code",CodeButton.prototype.icon="code",CodeButton.prototype.title=Simditor._t("code"),CodeButton.prototype.htmlTag="pre",CodeButton.prototype.disableTag="li, table",CodeButton.prototype._init=function(){return CodeButton.__super__._init.call(this),this.editor.on("decorate",function(_this){return function(e,$el){return $el.find("pre").each(function(i,pre){return _this.decorate($(pre))})}}(this)),this.editor.on("undecorate",function(_this){return function(e,$el){return $el.find("pre").each(function(i,pre){return _this.undecorate($(pre))})}}(this))},CodeButton.prototype.render=function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],CodeButton.__super__.render.apply(this,args),this.popover=new CodePopover({button:this})},CodeButton.prototype.status=function($node){var result;return result=CodeButton.__super__.status.call(this,$node),this.active?this.popover.show($node):this.editor.util.isBlockNode($node)&&this.popover.hide(),result},CodeButton.prototype.decorate=function($pre){var lang;return lang=$pre.attr("data-lang"),$pre.removeClass(),lang&&-1!==lang?$pre.addClass("lang-"+lang):void 0},CodeButton.prototype.undecorate=function($pre){var lang;return lang=$pre.attr("data-lang"),$pre.removeClass(),lang&&-1!==lang?$pre.addClass("lang-"+lang):void 0},CodeButton.prototype.command=function(){var $contents,$endBlock,$startBlock,endNode,node,range,results,startNode,_i,_len,_ref;for(range=this.editor.selection.getRange(),startNode=range.startContainer,endNode=range.endContainer,$startBlock=this.editor.util.closestBlockEl(startNode),$endBlock=this.editor.util.closestBlockEl(endNode),range.setStartBefore($startBlock[0]),range.setEndAfter($endBlock[0]),$contents=$(range.extractContents()),results=[],$contents.children().each(function(_this){return function(i,el){var c,converted,_i,_len,_results;for(converted=_this._convertEl(el),_results=[],_i=0,_len=converted.length;_len>_i;_i++)c=converted[_i],_results.push(results.length&&results[results.length-1].is(_this.htmlTag)&&c.is(_this.htmlTag)?results[results.length-1].append(c.contents()):results.push(c));return _results}}(this)),_ref=results.reverse(),_i=0,_len=_ref.length;_len>_i;_i++)node=_ref[_i],range.insertNode(node[0]);return this.editor.selection.setRangeAtEndOf(results[0]),this.editor.trigger("valuechanged")},CodeButton.prototype._convertEl=function(el){var $el,block,codeStr,results;return $el=$(el),results=[],$el.is(this.htmlTag)?(block=$("<p/>").append($el.html().replace("\n","<br/>")),results.push(block)):(codeStr=!$el.text()&&1===$el.children().length&&$el.children().is("br")?"\n":this.editor.formatter.clearHtml($el),block=$("<"+this.htmlTag+"/>").text(codeStr),results.push(block)),results},CodeButton}(Button),CodePopover=function(_super){function CodePopover(){return CodePopover.__super__.constructor.apply(this,arguments)}return __extends(CodePopover,_super),CodePopover.prototype._tpl='<div class="code-settings">\n  <div class="settings-field">\n    <select class="select-lang">\n      <option value="-1">选择程序语言</option>\n      <option value="c++">C++</option>\n      <option value="css">CSS</option>\n      <option value="coffeeScript">CoffeeScript</option>\n      <option value="html">Html,XML</option>\n      <option value="json">JSON</option>\n      <option value="java">Java</option>\n      <option value="js">JavaScript</option>\n      <option value="markdown">Markdown</option>\n      <option value="oc">Objective C</option>\n      <option value="php">PHP</option>\n      <option value="perl">Perl</option>\n      <option value="python">Python</option>\n      <option value="ruby">Ruby</option>\n      <option value="sql">SQL</option>\n    </select>\n  </div>\n</div>',CodePopover.prototype.render=function(){return this.el.addClass("code-popover").append(this._tpl),this.selectEl=this.el.find(".select-lang"),this.selectEl.on("change",function(_this){return function(){var selected;return _this.lang=_this.selectEl.val(),selected=_this.target.hasClass("selected"),_this.target.removeClass().removeAttr("data-lang"),-1!==_this.lang&&(_this.target.addClass("lang-"+_this.lang),_this.target.attr("data-lang",_this.lang)),selected?_this.target.addClass("selected"):void 0}}(this))},CodePopover.prototype.show=function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],CodePopover.__super__.show.apply(this,args),this.lang=this.target.attr("data-lang"),this.selectEl.val(null!=this.lang?this.lang:-1)},CodePopover}(Popover),Simditor.Toolbar.addButton(CodeButton);var LinkButton,LinkPopover,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__slice=[].slice;LinkButton=function(_super){function LinkButton(){return LinkButton.__super__.constructor.apply(this,arguments)}return __extends(LinkButton,_super),LinkButton.prototype.name="link",LinkButton.prototype.icon="link",LinkButton.prototype.title=Simditor._t("insertLink"),LinkButton.prototype.htmlTag="a",LinkButton.prototype.disableTag="pre",LinkButton.prototype.render=function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],LinkButton.__super__.render.apply(this,args),this.popover=new LinkPopover({button:this})},LinkButton.prototype.status=function($node){var showPopover;return null!=$node&&this.setDisabled($node.is(this.disableTag)),this.disabled?!0:null==$node?this.active:(showPopover=!0,!$node.is(this.htmlTag)||$node.is('[class^="simditor-"]')?(this.setActive(!1),showPopover=!1):this.editor.selection.rangeAtEndOf($node)?(this.setActive(!0),showPopover=!1):this.setActive(!0),showPopover?this.popover.show($node):this.editor.util.isBlockNode($node)&&this.popover.hide(),this.active)},LinkButton.prototype.command=function(){var $contents,$endBlock,$link,$newBlock,$startBlock,endNode,linkText,range,startNode,txtNode;return range=this.editor.selection.getRange(),this.active?($link=$(range.commonAncestorContainer).closest("a"),txtNode=document.createTextNode($link.text()),$link.replaceWith(txtNode),range.selectNode(txtNode)):(startNode=range.startContainer,endNode=range.endContainer,$startBlock=this.editor.util.closestBlockEl(startNode),$endBlock=this.editor.util.closestBlockEl(endNode),$contents=$(range.extractContents()),linkText=this.editor.formatter.clearHtml($contents.contents(),!1),$link=$("<a/>",{href:"http://www.example.com",target:"_blank",text:linkText||Simditor._t("linkText")}),$startBlock[0]===$endBlock[0]?range.insertNode($link[0]):($newBlock=$("<p/>").append($link),range.insertNode($newBlock[0])),range.selectNodeContents($link[0]),this.popover.one("popovershow",function(_this){return function(){return linkText?(_this.popover.urlEl.focus(),_this.popover.urlEl[0].select()):(_this.popover.textEl.focus(),_this.popover.textEl[0].select())}}(this))),this.editor.selection.selectRange(range),this.editor.trigger("valuechanged")},LinkButton}(Button),LinkPopover=function(_super){function LinkPopover(){return LinkPopover.__super__.constructor.apply(this,arguments)}return __extends(LinkPopover,_super),LinkPopover.prototype._tpl='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+Simditor._t("text")+'</label>\n    <input class="link-text" type="text"/>\n    <a class="btn-unlink" href="javascript:;" title="'+Simditor._t("removeLink")+'" tabindex="-1"><span class="fa fa-unlink"></span></a>\n  </div>\n  <div class="settings-field">\n    <label>'+Simditor._t("linkUrl")+'</label>\n    <input class="link-url" type="text"/>\n  </div>\n</div>',LinkPopover.prototype.render=function(){return this.el.addClass("link-popover").append(this._tpl),this.textEl=this.el.find(".link-text"),this.urlEl=this.el.find(".link-url"),this.unlinkEl=this.el.find(".btn-unlink"),this.textEl.on("keyup",function(_this){return function(e){return 13!==e.which?_this.target.text(_this.textEl.val()):void 0}}(this)),this.urlEl.on("keyup",function(_this){return function(e){var val;if(13!==e.which)return val=_this.urlEl.val(),!/https?:\/\/|^\//gi.test(val)&&val&&(val="http://"+val),_this.target.attr("href",val)}}(this)),$([this.urlEl[0],this.textEl[0]]).on("keydown",function(_this){return function(e){return 13===e.which||27===e.which||!e.shiftKey&&9===e.which&&$(e.target).hasClass("link-url")?(e.preventDefault(),setTimeout(function(){var range;return range=document.createRange(),_this.editor.selection.setRangeAfter(_this.target,range),_this.hide(),_this.editor.trigger("valuechanged")},0)):void 0}}(this)),this.unlinkEl.on("click",function(_this){return function(){var range,txtNode;return txtNode=document.createTextNode(_this.target.text()),_this.target.replaceWith(txtNode),_this.hide(),range=document.createRange(),_this.editor.selection.setRangeAfter(txtNode,range),_this.editor.trigger("valuechanged")}}(this))},LinkPopover.prototype.show=function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],LinkPopover.__super__.show.apply(this,args),this.textEl.val(this.target.text()),this.urlEl.val(this.target.attr("href"))},LinkPopover}(Popover),Simditor.Toolbar.addButton(LinkButton);var ImageButton,ImagePopover,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__slice=[].slice;ImageButton=function(_super){function ImageButton(){return ImageButton.__super__.constructor.apply(this,arguments)}return __extends(ImageButton,_super),ImageButton.prototype.name="image",ImageButton.prototype.icon="picture-o",ImageButton.prototype.title=Simditor._t("insertImage"),ImageButton.prototype.htmlTag="img",ImageButton.prototype.disableTag="pre, table",ImageButton.prototype.defaultImage="",ImageButton.prototype.needFocus=!1,ImageButton.prototype.menu=[{name:"upload-image",text:Simditor._t("localImage")},{name:"external-image",text:Simditor._t("externalImage")}],ImageButton.prototype._init=function(){return null==this.editor.uploader&&(this.menu=!1),ImageButton.__super__._init.call(this),this.defaultImage=this.editor.opts.defaultImage,this.editor.body.on("click","img:not([data-non-image])",function(_this){return function(e){var $img,range;return $img=$(e.currentTarget),range=document.createRange(),range.selectNode($img[0]),_this.editor.selection.selectRange(range),_this.editor.util.supportSelectionChange||_this.editor.trigger("selectionchanged"),!1}}(this)),this.editor.body.on("mouseup","img:not([data-non-image])",function(){return function(){return!1}}(this)),this.editor.on("selectionchanged.image",function(_this){return function(){var $contents,$img,range;return range=_this.editor.selection.sel.getRangeAt(0),null!=range?($contents=$(range.cloneContents()).contents(),1===$contents.length&&$contents.is("img:not([data-non-image])")?($img=$(range.startContainer).contents().eq(range.startOffset),_this.popover.show($img)):_this.popover.hide()):void 0}}(this)),this.editor.on("valuechanged.image",function(_this){return function(){var $masks;return $masks=_this.editor.wrapper.find(".simditor-image-loading"),$masks.length>0?$masks.each(function(i,mask){var $img,$mask,file;return $mask=$(mask),$img=$mask.data("img"),!($img&&$img.parent().length>0)&&($mask.remove(),$img&&(file=$img.data("file"),file&&(_this.editor.uploader.cancel(file),_this.editor.body.find("img.uploading").length<1)))?_this.editor.uploader.trigger("uploadready",[file]):void 0}):void 0}}(this))},ImageButton.prototype.render=function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],ImageButton.__super__.render.apply(this,args),this.popover=new ImagePopover({button:this})},ImageButton.prototype.renderMenu=function(){var $input,$uploadItem,createInput;return ImageButton.__super__.renderMenu.call(this),$uploadItem=this.menuEl.find(".menu-item-upload-image"),$input=null,createInput=function(){return function(){return $input&&$input.remove(),$input=$('<input type="file" title="'+Simditor._t("uploadImage")+'" accept="image/*">').appendTo($uploadItem)}}(this),createInput(),$uploadItem.on("click mousedown","input[type=file]",function(){return function(e){return e.stopPropagation()}}(this)),$uploadItem.on("change","input[type=file]",function(_this){return function(){return _this.editor.inputManager.focused?(_this.editor.uploader.upload($input,{inline:!0}),createInput()):(_this.editor.one("focus",function(){return _this.editor.uploader.upload($input,{inline:!0}),createInput()}),_this.editor.focus()),_this.wrapper.removeClass("menu-on")}}(this)),this._initUploader()},ImageButton.prototype._initUploader=function(){return null==this.editor.uploader?void this.el.find(".btn-upload").remove():(this.editor.uploader.on("beforeupload",function(_this){return function(e,file){var $img;if(file.inline)return file.img?$img=$(file.img):($img=_this.createImage(file.name),file.img=$img),$img.addClass("uploading"),$img.data("file",file),_this.editor.uploader.readImageFile(file.obj,function(img){var src;if($img.hasClass("uploading"))return src=img?img.src:_this.defaultImage,_this.loadImage($img,src,function(){return _this.popover.refresh(),_this.popover.srcEl.val("正在上传...").prop("disabled",!0)})})}}(this)),this.editor.uploader.on("uploadprogress",function(){return function(e,file,loaded,total){var $img,$mask,percent;if(file.inline)return percent=loaded/total,percent=(100*percent).toFixed(0),percent>99&&(percent=99),$mask=file.img.data("mask"),$mask?($img=$mask.data("img"),$img&&$img.parent().length>0?$mask.find("span").text(percent):$mask.remove()):void 0}}(this)),this.editor.uploader.on("uploadsuccess",function(_this){return function(e,file,result){var $img,$mask,msg;if(file.inline)return $img=file.img,$img.removeData("file"),$img.removeClass("uploading"),$mask=$img.data("mask"),$mask&&$mask.remove(),$img.removeData("mask"),result.success===!1?(msg=result.msg||Simditor._t("uploadFailed"),alert(msg),$img.attr("src",_this.defaultImage)):$img.attr("src",result.file_path),_this.popover.srcEl.prop("disabled",!1),_this.editor.trigger("valuechanged"),_this.editor.body.find("img.uploading").length<1?_this.editor.uploader.trigger("uploadready",[file,result]):void 0}}(this)),this.editor.uploader.on("uploaderror",function(_this){return function(e,file,xhr){var $img,$mask,msg,result;if(file.inline&&"abort"!==xhr.statusText){if(xhr.responseText){try{result=$.parseJSON(xhr.responseText),msg=result.msg}catch(_error){e=_error,msg=Simditor._t("uploadError")}alert(msg)}return $img=file.img,$img.removeData("file"),$img.removeClass("uploading"),$mask=$img.data("mask"),$mask&&$mask.remove(),$img.removeData("mask"),$img.attr("src",_this.defaultImage),_this.popover.srcEl.prop("disabled",!1),_this.editor.trigger("valuechanged"),_this.editor.body.find("img.uploading").length<1?_this.editor.uploader.trigger("uploadready",[file,result]):void 0}}}(this)))},ImageButton.prototype.status=function($node){return null!=$node&&this.setDisabled($node.is(this.disableTag)),this.disabled?!0:void 0},ImageButton.prototype.loadImage=function($img,src,callback){var $mask,img;return $mask=$img.data("mask"),$mask||($mask=$('<div class="simditor-image-loading"><span></span></div>').hide().appendTo(this.editor.wrapper),$img.hasClass("uploading")&&$mask.addClass("uploading"),$img.data("mask",$mask),$mask.data("img",$img)),img=new Image,img.onload=function(_this){return function(){var height,imgOffset,width,wrapperOffset;return width=img.width,height=img.height,$img.attr({src:src,"data-image-size":width+","+height}),$img.hasClass("uploading")?(_this.editor.util.reflow(_this.editor.body),wrapperOffset=_this.editor.wrapper.offset(),imgOffset=$img.offset(),$mask.css({top:imgOffset.top-wrapperOffset.top,left:imgOffset.left-wrapperOffset.left,width:$img.width(),height:$img.height()}).show()):($mask.remove(),$img.removeData("mask")),callback(img)}}(this),img.onerror=function(){return function(){return callback(!1),$mask.remove(),$img.removeData("mask")}}(this),img.src=src},ImageButton.prototype.createImage=function(name){var $block,$img,$nextBlock,range;return null==name&&(name="Image"),this.editor.inputManager.focused||this.editor.focus(),range=this.editor.selection.getRange(),range.deleteContents(),$block=this.editor.util.closestBlockEl(),$block.is("p")&&!this.editor.util.isEmptyNode($block)&&($block=$("<p/>").append(this.editor.util.phBr).insertAfter($block),this.editor.selection.setRangeAtStartOf($block,range)),$img=$("<img/>").attr("alt",name),range.insertNode($img[0]),$nextBlock=$block.next("p"),$nextBlock.length>0||($nextBlock=$("<p/>").append(this.editor.util.phBr).insertAfter($block)),this.editor.selection.setRangeAtStartOf($nextBlock),$img},ImageButton.prototype.command=function(src){var $img;return $img=this.createImage(),this.loadImage($img,src||this.defaultImage,function(_this){return function(){return _this.editor.trigger("valuechanged"),_this.editor.util.reflow($img),$img.click(),_this.popover.one("popovershow",function(){return _this.popover.srcEl.focus(),_this.popover.srcEl[0].select()})}}(this))},ImageButton}(Button),ImagePopover=function(_super){function ImagePopover(){return ImagePopover.__super__.constructor.apply(this,arguments)}return __extends(ImagePopover,_super),ImagePopover.prototype._tpl='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+Simditor._t("imageUrl")+'</label>\n    <input class="image-src" type="text" tabindex="1" />\n    <a class="btn-upload" href="javascript:;" title="'+Simditor._t("uploadImage")+'" tabindex="-1">\n      <span class="fa fa-upload"></span>\n    </a>\n  </div>\n  <div class="settings-field">\n    <label>'+Simditor._t("imageSize")+'</label>\n    <input class="image-size" id="image-width" type="text" tabindex="2" />\n    <span class="times">×</span>\n    <input class="image-size" id="image-height" type="text" tabindex="3" />\n    <a class="btn-restore" href="javascript:;" title="'+Simditor._t("restoreImageSize")+'" tabindex="-1">\n      <span class="fa fa-reply"></span>\n    </a>\n  </div>\n</div>',ImagePopover.prototype.offset={top:6,left:-4},ImagePopover.prototype.render=function(){return this.el.addClass("image-popover").append(this._tpl),this.srcEl=this.el.find(".image-src"),this.srcEl.on("keydown",function(_this){return function(e){var src;return 13===e.which||27===e.which?(e.preventDefault(),13!==e.which||_this.target.hasClass("uploading")?(_this.button.editor.body.focus(),_this.button.editor.selection.setRangeAfter(_this.target),_this.hide()):(src=_this.srcEl.val(),_this.button.loadImage(_this.target,src,function(success){return success?(_this.button.editor.body.focus(),_this.button.editor.selection.setRangeAfter(_this.target),_this.hide(),_this.editor.trigger("valuechanged")):void 0
}))):void 0}}(this)),this.widthEl=this.el.find("#image-width"),this.heightEl=this.el.find("#image-height"),this.el.find(".image-size").on("blur",function(_this){return function(e){return _this._resizeImg($(e.currentTarget)),_this.el.data("popover").refresh()}}(this)),this.el.find(".image-size").on("keyup",function(_this){return function(e){var inputEl;return inputEl=$(e.currentTarget),13!==e.which&&27!==e.which&&9!==e.which?_this._resizeImg(inputEl,!0):void 0}}(this)),this.el.find(".image-size").on("keydown",function(_this){return function(e){var inputEl;return inputEl=$(e.currentTarget),13===e.which||27===e.which?(e.preventDefault(),13===e.which?_this._resizeImg(inputEl):_this._restoreImg(),_this.button.editor.body.focus(),_this.button.editor.selection.setRangeAfter(_this.target),_this.hide()):9===e.which?_this.el.data("popover").refresh():void 0}}(this)),this.el.find(".btn-restore").on("click",function(_this){return function(){return _this._restoreImg(),_this.el.data("popover").refresh()}}(this)),this.editor.on("valuechanged",function(_this){return function(){return _this.active?_this.refresh():void 0}}(this)),this._initUploader()},ImagePopover.prototype._initUploader=function(){var $uploadBtn,createInput;return $uploadBtn=this.el.find(".btn-upload"),null==this.editor.uploader?void $uploadBtn.remove():(createInput=function(_this){return function(){return _this.input&&_this.input.remove(),_this.input=$('<input type="file" title="'+Simditor._t("uploadImage")+'" accept="image/*">').appendTo($uploadBtn)}}(this),createInput(),this.el.on("click mousedown","input[type=file]",function(){return function(e){return e.stopPropagation()}}(this)),this.el.on("change","input[type=file]",function(_this){return function(){return _this.editor.uploader.upload(_this.input,{inline:!0,img:_this.target}),createInput()}}(this)))},ImagePopover.prototype._resizeImg=function(inputEl,onlySetVal){var height,value,width;return null==onlySetVal&&(onlySetVal=!1),value=1*inputEl.val(),$.isNumeric(value)||0>value?(inputEl.is(this.widthEl)?(height=this.height*value/this.width,this.heightEl.val(height)):(width=this.width*value/this.height,this.widthEl.val(width)),onlySetVal?void 0:this.target.attr({width:width||value,height:height||value})):void 0},ImagePopover.prototype._restoreImg=function(){var size,_ref;return size=(null!=(_ref=this.target.data("image-size"))?_ref.split(","):void 0)||[this.width,this.height],this.target.attr({width:1*size[0],height:1*size[1]}),this.widthEl.val(size[0]),this.heightEl.val(size[1])},ImagePopover.prototype.show=function(){var $img,args;return args=1<=arguments.length?__slice.call(arguments,0):[],ImagePopover.__super__.show.apply(this,args),$img=this.target,this.width=$img.width(),this.height=$img.height(),$img.hasClass("uploading")?this.srcEl.val(Simditor._t("uploading")):(this.srcEl.val($img.attr("src")),this.widthEl.val(this.width),this.heightEl.val(this.height))},ImagePopover}(Popover),Simditor.Toolbar.addButton(ImageButton);var IndentButton,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};IndentButton=function(_super){function IndentButton(){return IndentButton.__super__.constructor.apply(this,arguments)}return __extends(IndentButton,_super),IndentButton.prototype.name="indent",IndentButton.prototype.icon="indent",IndentButton.prototype.title=Simditor._t("indent")+" (Tab)",IndentButton.prototype.status=function(){return!0},IndentButton.prototype.command=function(){return this.editor.util.indent()},IndentButton}(Button),Simditor.Toolbar.addButton(IndentButton);var OutdentButton,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};OutdentButton=function(_super){function OutdentButton(){return OutdentButton.__super__.constructor.apply(this,arguments)}return __extends(OutdentButton,_super),OutdentButton.prototype.name="outdent",OutdentButton.prototype.icon="outdent",OutdentButton.prototype.title=Simditor._t("outdent")+" (Shift + Tab)",OutdentButton.prototype.status=function(){return!0},OutdentButton.prototype.command=function(){return this.editor.util.outdent()},OutdentButton}(Button),Simditor.Toolbar.addButton(OutdentButton);var HrButton,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};HrButton=function(_super){function HrButton(){return HrButton.__super__.constructor.apply(this,arguments)}return __extends(HrButton,_super),HrButton.prototype.name="hr",HrButton.prototype.icon="minus",HrButton.prototype.title=Simditor._t("hr"),HrButton.prototype.htmlTag="hr",HrButton.prototype.status=function(){return!0},HrButton.prototype.command=function(){var $hr,$newBlock,$nextBlock,$rootBlock;return $rootBlock=this.editor.util.furthestBlockEl(),$nextBlock=$rootBlock.next(),$nextBlock.length>0?this.editor.selection.save():$newBlock=$("<p/>").append(this.editor.util.phBr),$hr=$("<hr/>").insertAfter($rootBlock),$newBlock?($newBlock.insertAfter($hr),this.editor.selection.setRangeAtStartOf($newBlock)):this.editor.selection.restore(),this.editor.trigger("valuechanged")},HrButton}(Button),Simditor.Toolbar.addButton(HrButton);var TableButton,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};TableButton=function(_super){function TableButton(){return TableButton.__super__.constructor.apply(this,arguments)}return __extends(TableButton,_super),TableButton.prototype.name="table",TableButton.prototype.icon="table",TableButton.prototype.title=Simditor._t("table"),TableButton.prototype.htmlTag="table",TableButton.prototype.disableTag="pre, li, blockquote",TableButton.prototype.menu=!0,TableButton.prototype._init=function(){return TableButton.__super__._init.call(this),$.merge(this.editor.formatter._allowedTags,["tbody","tr","td","colgroup","col"]),$.extend(this.editor.formatter._allowedAttributes,{td:["rowspan","colspan"],col:["width"]}),this.editor.on("decorate",function(_this){return function(e,$el){return $el.find("table").each(function(i,table){return _this.decorate($(table))})}}(this)),this.editor.on("undecorate",function(_this){return function(e,$el){return $el.find("table").each(function(i,table){return _this.undecorate($(table))})}}(this)),this.editor.on("selectionchanged.table",function(_this){return function(){var $container,range;return _this.editor.body.find(".simditor-table td").removeClass("active"),range=_this.editor.selection.getRange(),null!=range?($container=$(range.commonAncestorContainer),range.collapsed&&$container.is(".simditor-table")&&($container=$container.find(_this.editor.selection.rangeAtStartOf($container)?"td:first":"td:last"),_this.editor.selection.setRangeAtEndOf($container)),$container.closest("td",_this.editor.body).addClass("active")):void 0}}(this)),this.editor.on("blur.table",function(_this){return function(){return _this.editor.body.find(".simditor-table td").removeClass("active")}}(this)),this.editor.inputManager.addKeystrokeHandler("38","td",function(_this){return function(e,$node){var $prevTr,$tr,index;return $tr=$node.parent("tr"),$prevTr=$tr.prev("tr"),$prevTr.length>0?(index=$tr.find("td").index($node),_this.editor.selection.setRangeAtEndOf($prevTr.find("td").eq(index)),!0):!0}}(this)),this.editor.inputManager.addKeystrokeHandler("40","td",function(_this){return function(e,$node){var $nextTr,$tr,index;return $tr=$node.parent("tr"),$nextTr=$tr.next("tr"),$nextTr.length>0?(index=$tr.find("td").index($node),_this.editor.selection.setRangeAtEndOf($nextTr.find("td").eq(index)),!0):!0}}(this))},TableButton.prototype.initResize=function($table){var $colgroup,$resizeHandle,$wrapper;return $wrapper=$table.parent(".simditor-table"),$colgroup=$table.find("colgroup"),$colgroup.length<1&&($colgroup=$("<colgroup/>").prependTo($table),$table.find("tr:first td").each(function(){return function(){var $col;return $col=$("<col/>").appendTo($colgroup)}}(this)),this.refreshTableWidth($table)),$resizeHandle=$('<div class="simditor-resize-handle" contenteditable="false"></div>').appendTo($wrapper),$wrapper.on("mousemove","td",function(){return function(e){var $col,$td,index,x,_ref,_ref1;if(!$wrapper.hasClass("resizing"))return $td=$(e.currentTarget),x=e.pageX-$(e.currentTarget).offset().left,5>x&&$td.prev().length>0&&($td=$td.prev()),$td.next("td").length<1?void $resizeHandle.hide():(null!=(_ref=$resizeHandle.data("td"))?_ref.is($td):void 0)?void $resizeHandle.show():(index=$td.parent().find("td").index($td),$col=$colgroup.find("col").eq(index),(null!=(_ref1=$resizeHandle.data("col"))?_ref1.is($col):void 0)?void $resizeHandle.show():$resizeHandle.css("left",$td.position().left+$td.outerWidth()-5).data("td",$td).data("col",$col).show())}}(this)),$wrapper.on("mouseleave",function(){return function(){return $resizeHandle.hide()}}(this)),$wrapper.on("mousedown",".simditor-resize-handle",function(){return function(e){var $handle,$leftCol,$leftTd,$rightCol,$rightTd,minWidth,startHandleLeft,startLeftWidth,startRightWidth,startX,tableWidth;return $handle=$(e.currentTarget),$leftTd=$handle.data("td"),$leftCol=$handle.data("col"),$rightTd=$leftTd.next("td"),$rightCol=$leftCol.next("col"),startX=e.pageX,startLeftWidth=1*$leftTd.outerWidth(),startRightWidth=1*$rightTd.outerWidth(),startHandleLeft=parseFloat($handle.css("left")),tableWidth=$leftTd.closest("table").width(),minWidth=50,$(document).on("mousemove.simditor-resize-table",function(e){var deltaX,leftWidth,rightWidth;return deltaX=e.pageX-startX,leftWidth=startLeftWidth+deltaX,rightWidth=startRightWidth-deltaX,minWidth>leftWidth?(leftWidth=minWidth,deltaX=minWidth-startLeftWidth,rightWidth=startRightWidth-deltaX):minWidth>rightWidth&&(rightWidth=minWidth,deltaX=startRightWidth-minWidth,leftWidth=startLeftWidth+deltaX),$leftCol.attr("width",leftWidth/tableWidth*100+"%"),$rightCol.attr("width",rightWidth/tableWidth*100+"%"),$handle.css("left",startHandleLeft+deltaX)}),$(document).one("mouseup.simditor-resize-table",function(){return $(document).off(".simditor-resize-table"),$wrapper.removeClass("resizing")}),$wrapper.addClass("resizing"),!1}}(this))},TableButton.prototype.decorate=function($table){return $table.parent(".simditor-table").length>0&&this.undecorate($table),$table.wrap('<div class="simditor-table"></div>'),this.initResize($table),$table.parent()},TableButton.prototype.undecorate=function($table){return $table.parent(".simditor-table").length>0?$table.parent().replaceWith($table):void 0},TableButton.prototype.renderMenu=function(){return $('<div class="menu-create-table">\n</div>\n<div class="menu-edit-table">\n  <ul>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteRow"><span>'+Simditor._t("deleteRow")+'</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertRowAbove"><span>'+Simditor._t("insertRowAbove")+'</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertRowBelow"><span>'+Simditor._t("insertRowBelow")+'</span></a></li>\n    <li><span class="separator"></span></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteCol"><span>'+Simditor._t("delteColumn")+'</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertColLeft"><span>'+Simditor._t("insertColumnLeft")+'</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertColRight"><span>'+Simditor._t("insertColumnRight")+'</span></a></li>\n    <li><span class="separator"></span></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteTable"><span>'+Simditor._t("deleteTable")+"</span></a></li>\n  </ul>\n</div>").appendTo(this.menuWrapper),this.createMenu=this.menuWrapper.find(".menu-create-table"),this.editMenu=this.menuWrapper.find(".menu-edit-table"),this.createTable(6,6).appendTo(this.createMenu),this.createMenu.on("mouseenter","td",function(_this){return function(e){var $td,$tr,num;return _this.createMenu.find("td").removeClass("selected"),$td=$(e.currentTarget),$tr=$td.parent(),num=$tr.find("td").index($td)+1,$tr.prevAll("tr").addBack().find("td:lt("+num+")").addClass("selected")}}(this)),this.createMenu.on("mouseleave",function(){return function(e){return $(e.currentTarget).find("td").removeClass("selected")}}(this)),this.createMenu.on("mousedown","td",function(_this){return function(e){var $closestBlock,$table,$td,$tr,colNum,rowNum;return _this.wrapper.removeClass("menu-on"),_this.editor.inputManager.focused?($td=$(e.currentTarget),$tr=$td.parent(),colNum=$tr.find("td").index($td)+1,rowNum=$tr.prevAll("tr").length+1,$table=_this.createTable(rowNum,colNum,!0),$closestBlock=_this.editor.util.closestBlockEl(),_this.editor.util.isEmptyNode($closestBlock)?$closestBlock.replaceWith($table):$closestBlock.after($table),_this.decorate($table),_this.editor.selection.setRangeAtStartOf($table.find("td:first")),_this.editor.trigger("valuechanged"),!1):void 0}}(this))},TableButton.prototype.createTable=function(row,col,phBr){var $table,$tbody,$td,$tr,c,r,_i,_j;for($table=$("<table/>"),$tbody=$("<tbody/>").appendTo($table),r=_i=0;row>=0?row>_i:_i>row;r=row>=0?++_i:--_i)for($tr=$("<tr/>").appendTo($tbody),c=_j=0;col>=0?col>_j:_j>col;c=col>=0?++_j:--_j)$td=$("<td/>").appendTo($tr),phBr&&$td.append(this.editor.util.phBr);return $table},TableButton.prototype.refreshTableWidth=function($table){var cols,tableWidth;return tableWidth=$table.width(),cols=$table.find("col"),$table.find("tr:first td").each(function(){return function(i,td){var $col;return $col=cols.eq(i),$col.attr("width",$(td).outerWidth()/tableWidth*100+"%")}}(this))},TableButton.prototype.setActive=function(active){return TableButton.__super__.setActive.call(this,active),active?(this.createMenu.hide(),this.editMenu.show()):(this.createMenu.show(),this.editMenu.hide())},TableButton.prototype.deleteRow=function($td){var $newTr,$tr,index;return $tr=$td.parent("tr"),$tr.siblings("tr").length<1?this.deleteTable($td):($newTr=$tr.next("tr"),$newTr.length>0||($newTr=$tr.prev("tr")),index=$tr.find("td").index($td),$tr.remove(),this.editor.selection.setRangeAtEndOf($newTr.find("td").eq(index)))},TableButton.prototype.insertRow=function($td,direction){var $newTr,$table,$tr,colNum,i,index,_i;for(null==direction&&(direction="after"),$tr=$td.parent("tr"),$table=$tr.closest("table"),colNum=0,$table.find("tr").each(function(){return function(i,tr){return colNum=Math.max(colNum,$(tr).find("td").length)}}(this)),$newTr=$("<tr/>"),i=_i=1;colNum>=1?colNum>=_i:_i>=colNum;i=colNum>=1?++_i:--_i)$("<td/>").append(this.editor.util.phBr).appendTo($newTr);return $tr[direction]($newTr),index=$tr.find("td").index($td),this.editor.selection.setRangeAtStartOf($newTr.find("td").eq(index))},TableButton.prototype.deleteCol=function($td){var $newTd,$table,$tr,index;return $tr=$td.parent("tr"),$tr.siblings("tr").length<1&&$td.siblings("td").length<1?this.deleteTable($td):(index=$tr.find("td").index($td),$newTd=$td.next("td"),$newTd.length>0||($newTd=$tr.prev("td")),$table=$tr.closest("table"),$table.find("col").eq(index).remove(),$table.find("tr").each(function(){return function(i,tr){return $(tr).find("td").eq(index).remove()}}(this)),this.refreshTableWidth($table),this.editor.selection.setRangeAtEndOf($newTd))},TableButton.prototype.insertCol=function($td,direction){var $col,$newCol,$newTd,$table,$tr,index,tableWidth,width;return null==direction&&(direction="after"),$tr=$td.parent("tr"),index=$tr.find("td").index($td),$table=$td.closest("table"),$col=$table.find("col").eq(index),$table.find("tr").each(function(_this){return function(i,tr){var $newTd;return $newTd=$("<td/>").append(_this.editor.util.phBr),$(tr).find("td").eq(index)[direction]($newTd)}}(this)),$newCol=$("<col/>"),$col[direction]($newCol),tableWidth=$table.width(),width=Math.max(parseFloat($col.attr("width"))/2,50/tableWidth*100),$col.attr("width",width+"%"),$newCol.attr("width",width+"%"),this.refreshTableWidth($table),$newTd="after"===direction?$td.next("td"):$td.prev("td"),this.editor.selection.setRangeAtStartOf($newTd)},TableButton.prototype.deleteTable=function($td){var $block,$table;return $table=$td.closest(".simditor-table"),$block=$table.next("p"),$table.remove(),$block.length>0?this.editor.selection.setRangeAtStartOf($block):void 0},TableButton.prototype.command=function(param){var $td,range;if(range=this.editor.selection.getRange(),$td=$(range.commonAncestorContainer).closest("td"),$td.length>0){if("deleteRow"===param)this.deleteRow($td);else if("insertRowAbove"===param)this.insertRow($td,"before");else if("insertRowBelow"===param)this.insertRow($td);else if("deleteCol"===param)this.deleteCol($td);else if("insertColLeft"===param)this.insertCol($td,"before");else if("insertColRight"===param)this.insertCol($td);else{if("deleteTable"!==param)return;this.deleteTable($td)}return this.editor.trigger("valuechanged")}},TableButton}(Button),Simditor.Toolbar.addButton(TableButton);var StrikethroughButton,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};return StrikethroughButton=function(_super){function StrikethroughButton(){return StrikethroughButton.__super__.constructor.apply(this,arguments)}return __extends(StrikethroughButton,_super),StrikethroughButton.prototype.name="strikethrough",StrikethroughButton.prototype.icon="strikethrough",StrikethroughButton.prototype.title=Simditor._t("strikethrough"),StrikethroughButton.prototype.htmlTag="strike",StrikethroughButton.prototype.disableTag="pre",StrikethroughButton.prototype.status=function($node){var active;return null!=$node&&this.setDisabled($node.is(this.disableTag)),this.disabled?!0:(active=document.queryCommandState("strikethrough")===!0,this.setActive(active),active)},StrikethroughButton.prototype.command=function(){return document.execCommand("strikethrough"),this.editor.trigger("valuechanged"),$(document).trigger("selectionchange")},StrikethroughButton}(Button),Simditor.Toolbar.addButton(StrikethroughButton),Simditor});