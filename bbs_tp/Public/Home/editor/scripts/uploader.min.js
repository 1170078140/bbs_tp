!function(root,factory){"function"==typeof define&&define.amd?define("simple-uploader",["jquery","simple-module"],function($,SimpleModule){return root.returnExportsGlobal=factory($,SimpleModule)}):"object"==typeof exports?module.exports=factory(require("jquery"),require("simple-module")):(root.simple=root.simple||{},root.simple.uploader=factory(jQuery,SimpleModule))}(this,function($,SimpleModule){var Uploader,uploader,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};return Uploader=function(_super){function Uploader(){return Uploader.__super__.constructor.apply(this,arguments)}return __extends(Uploader,_super),Uploader.count=0,Uploader.prototype.opts={url:"",params:null,fileKey:"upload_file",connectionCount:3},Uploader.prototype._init=function(){return this.files=[],this.queue=[],this.id=++Uploader.count,this.on("uploadcomplete",function(_this){return function(e,file){return _this.files.splice($.inArray(file,_this.files),1),_this.queue.length>0&&_this.files.length<_this.opts.connectionCount?_this.upload(_this.queue.shift()):_this.uploading=!1}}(this)),$(window).on("beforeunload.uploader-"+this.id,function(_this){return function(e){return _this.uploading?(e.originalEvent.returnValue=_this._t("leaveConfirm"),_this._t("leaveConfirm")):void 0}}(this))},Uploader.prototype.generateId=function(){var id;return id=0,function(){return id+=1}}(),Uploader.prototype.upload=function(file,opts){var f,key,_i,_len;if(null==opts&&(opts={}),null!=file){if($.isArray(file))for(_i=0,_len=file.length;_len>_i;_i++)f=file[_i],this.upload(f,opts);else $(file).is("input:file")?(key=$(file).attr("name"),key&&(opts.fileKey=key),this.upload($.makeArray($(file)[0].files),opts)):file.id&&file.obj||(file=this.getFile(file));if(file&&file.obj){if($.extend(file,opts),this.files.length>=this.opts.connectionCount)return void this.queue.push(file);if(this.triggerHandler("beforeupload",[file])!==!1)return this.files.push(file),this._xhrUpload(file),this.uploading=!0}}},Uploader.prototype.getFile=function(fileObj){var name,_ref,_ref1;return fileObj instanceof window.File||fileObj instanceof window.Blob?(name=null!=(_ref=fileObj.fileName)?_ref:fileObj.name,{id:this.generateId(),url:this.opts.url,params:this.opts.params,fileKey:this.opts.fileKey,name:name,size:null!=(_ref1=fileObj.fileSize)?_ref1:fileObj.size,ext:name?name.split(".").pop().toLowerCase():"",obj:fileObj}):null},Uploader.prototype._xhrUpload=function(file){var formData,k,v,_ref;if(formData=new FormData,formData.append(file.fileKey,file.obj),formData.append("original_filename",file.name),file.params){_ref=file.params;for(k in _ref)v=_ref[k],formData.append(k,v)}return file.xhr=$.ajax({url:file.url,data:formData,dataType:"json",processData:!1,contentType:!1,type:"POST",headers:{"X-File-Name":encodeURIComponent(file.name)},xhr:function(){var req;return req=$.ajaxSettings.xhr(),req&&(req.upload.onprogress=function(_this){return function(e){return _this.progress(e)}}(this)),req},progress:function(_this){return function(e){return e.lengthComputable?_this.trigger("uploadprogress",[file,e.loaded,e.total]):void 0}}(this),error:function(_this){return function(xhr,status){return _this.trigger("uploaderror",[file,xhr,status])}}(this),success:function(_this){return function(result){return _this.trigger("uploadprogress",[file,file.size,file.size]),_this.trigger("uploadsuccess",[file,result])}}(this),complete:function(_this){return function(xhr){return _this.trigger("uploadcomplete",[file,xhr.responseText])}}(this)})},Uploader.prototype.cancel=function(file){var f,_i,_len,_ref;if(!file.id)for(_ref=this.files,_i=0,_len=_ref.length;_len>_i;_i++)if(f=_ref[_i],f.id===1*file){file=f;break}return this.trigger("uploadcancel",[file]),file.xhr&&file.xhr.abort(),file.xhr=null},Uploader.prototype.readImageFile=function(fileObj,callback){var fileReader,img;if($.isFunction(callback))return img=new Image,img.onload=function(){return callback(img)},img.onerror=function(){return callback()},window.FileReader&&FileReader.prototype.readAsDataURL&&/^image/.test(fileObj.type)?(fileReader=new FileReader,fileReader.onload=function(e){return img.src=e.target.result},fileReader.readAsDataURL(fileObj)):callback()},Uploader.prototype.destroy=function(){var file,_i,_len,_ref;for(this.queue.length=0,_ref=this.files,_i=0,_len=_ref.length;_len>_i;_i++)file=_ref[_i],this.cancel(file);return $(window).off(".uploader-"+this.id),$(document).off(".uploader-"+this.id)},Uploader.i18n={"zh-CN":{leaveConfirm:"正在上传文件，如果离开上传会自动取消"}},Uploader.locale="zh-CN",Uploader}(SimpleModule),uploader=function(opts){return new Uploader(opts)}});